name: macOS 26 SSH - Simuladores iOS (Gratis)

on:
  workflow_dispatch:

jobs:
  macos-ssh-server:
    runs-on: macos-26
    
    steps:
      - name: InformaciÃ³n del Sistema
        run: |
          echo "ðŸ–¥ï¸  macOS $(sw_vers -productVersion)"
          echo "ðŸ”§ $(uname -m)"
          xcodebuild -version
      
      - name: Instalar .NET MAUI
        run: |
          brew install --cask dotnet-sdk
          sudo dotnet workload install maui ios maccatalyst --skip-manifest-update
          echo "âœ… .NET MAUI listo"
      
      - name: Instalar Java y CocoaPods para KMP
        run: |
          brew install openjdk@17
          sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
          sudo gem install cocoapods
          echo "âœ… KMP dependencies listas"
      
      - name: Configurar Xcode
        run: |
          sudo xcodebuild -license accept
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          echo "âœ… Xcode configurado"
      
      - name: Configurar contraseÃ±a para usuario runner
        run: |
          # Establecer contraseÃ±a para el usuario runner (necesario para Pair to Mac)
          sudo dscl . -passwd /Users/runner "runner123"
          echo "âœ… ContraseÃ±a del usuario runner configurada: runner123"
      
      - name: Crear carpeta para screenshots
        run: |
          mkdir -p ~/Screenshots
          echo "âœ… Carpeta ~/Screenshots creada"
      
      - name: Usar tmate para acceso SSH
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 350
        with:
          detached: true
      
      - name: Mostrar instrucciones
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ CÃ“MO CONECTARTE DESDE WINDOWS"
          echo "=========================================="
          echo ""
          echo "ðŸŽ¯ OPCIÃ“N 1: SSH DIRECTO (Terminal)"
          echo "----------------------------------------"
          echo ""
          echo "1. Busca arriba el comando: ssh xxxxx@xxx.tmate.io"
          echo "2. EjecÃºtalo en PowerShell"
          echo "3. Â¡Ya tienes acceso al macOS!"
          echo ""
          echo "=========================================="
          echo "ðŸŽ¯ OPCIÃ“N 2: VISUAL STUDIO 2022 (Pair to Mac)"
          echo "=========================================="
          echo ""
          echo "Para emparejar Visual Studio con este Mac:"
          echo ""
          echo "PASO 1 - En PowerShell, ejecuta (reemplaza xxxxx con tu cÃ³digo tmate):"
          echo "   ssh -L 22:localhost:22 xxxxx@xxx.tmate.io"
          echo ""
          echo "PASO 2 - Deja esa ventana abierta (mantiene el tÃºnel)"
          echo ""
          echo "PASO 3 - En Visual Studio 2022:"
          echo "   â€¢ Herramientas > iOS > Emparejar con Mac"
          echo "   â€¢ Clic en 'Agregar Mac...'"
          echo "   â€¢ DirecciÃ³n IP: localhost"
          echo "   â€¢ Usuario: runner"
          echo "   â€¢ ContraseÃ±a: (dejar vacÃ­o, usa clave SSH de tmate)"
          echo ""
          echo "âš ï¸  NOTA: Si pide contraseÃ±a, primero configura una:"
          echo "   En la sesiÃ³n SSH ejecuta: sudo dscl . -passwd /Users/runner TU_CONTRASEÃ‘A"
          echo ""
          echo "=========================================="
          echo "ðŸ“± COMANDOS ÃšTILES PARA EL SIMULADOR"
          echo "----------------------------------------"
          echo ""
          echo "Ver simuladores:"
          echo "  xcrun simctl list devices available"
          echo ""
          echo "Iniciar simulador:"
          echo "  xcrun simctl boot 'iPhone 16 Pro'"
          echo "  open -a Simulator"
          echo ""
          echo "ðŸ“¸ Capturar screenshot:"
          echo "  ~/screenshot.sh"
          echo ""
          echo "ðŸ”§ Compilar .NET MAUI:"
          echo "  dotnet build -f net10.0-ios"
          echo ""
          echo "=========================================="
      
      - name: Iniciar Simulator
        run: |
          echo "ðŸ“± Buscando simuladores disponibles..."
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -5
          
          # Obtener el UUID del iPhone 16 Pro
          DEVICE_UUID=$(xcrun simctl list devices available | grep "iPhone 16 Pro (" | head -1 | grep -oE '[A-F0-9-]{36}')
          
          if [ -n "$DEVICE_UUID" ]; then
            echo "ðŸ“± Iniciando iPhone 16 Pro: $DEVICE_UUID"
            xcrun simctl boot "$DEVICE_UUID" 2>/dev/null || true
            open -a Simulator
            sleep 10
            
            # Capturar screenshot inicial
            xcrun simctl io booted screenshot ~/Screenshots/simulator_inicial.png 2>/dev/null || true
            echo "âœ… Simulator iniciado - Screenshot guardado en ~/Screenshots/"
          else
            echo "âš ï¸ No se encontrÃ³ iPhone 16 Pro"
            open -a Simulator
          fi
      
      - name: Iniciar servidor HTTP para screenshots
        run: |
          cd ~/Screenshots
          python3 -m http.server 8080 &
          sleep 2
          echo "âœ… Servidor HTTP iniciado en puerto 8080"
          echo "ðŸ“ Los screenshots estarÃ¡n en ~/Screenshots/"
      
      - name: Crear script de ayuda
        run: |
          cat > ~/screenshot.sh << 'SCRIPT'
          #!/bin/bash
          FILENAME="screen_$(date +%Y%m%d_%H%M%S).png"
          xcrun simctl io booted screenshot ~/Screenshots/$FILENAME
          echo "âœ… Screenshot guardado: ~/Screenshots/$FILENAME"
          echo "ðŸ“ Ver todos: ls ~/Screenshots/"
          SCRIPT
          chmod +x ~/screenshot.sh
          
          cat > ~/grabar.sh << 'SCRIPT'
          #!/bin/bash
          FILENAME="video_$(date +%Y%m%d_%H%M%S).mov"
          echo "ðŸŽ¬ Grabando... Presiona Ctrl+C para detener"
          xcrun simctl io booted recordVideo ~/Screenshots/$FILENAME
          SCRIPT
          chmod +x ~/grabar.sh
          
          echo "âœ… Scripts creados:"
          echo "   ~/screenshot.sh - Capturar pantalla"
          echo "   ~/grabar.sh - Grabar video"
      
      - name: Mantener servidor activo
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸš€ SERVIDOR ACTIVO"
          echo "=========================================="
          echo ""
          echo "ðŸ“ CONEXIÃ“N SSH:"
          echo "   Busca arriba: ssh xxxxx@xxx.tmate.io"
          echo ""
          echo "ðŸ”— PARA VISUAL STUDIO (Pair to Mac):"
          echo "   1. PowerShell: ssh -L 22:localhost:22 xxxxx@xxx.tmate.io"
          echo "   2. VS2022: Emparejar con Mac > Agregar Mac > localhost"
          echo "   3. Usuario: runner | ContraseÃ±a: runner123"
          echo ""
          echo "ðŸ“¸ Para screenshots: ~/screenshot.sh"
          echo ""
          echo "ðŸ’¡ Cancela el workflow cuando termines"
          echo ""
          echo "=========================================="
          
          while true; do
            sleep 60
            
            # Mantener Simulator activo
            if ! pgrep -f Simulator > /dev/null; then
              open -a Simulator 2>/dev/null || true
            fi
            
            echo "âœ“ $(date '+%H:%M:%S') - Servidor activo"
          done
      
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando..."
          pkill -f "python3 -m http.server" || true
          echo "âœ… Limpieza completada"
