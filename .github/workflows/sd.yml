name: macOS VNC - Simuladores iOS (Gratis)

on:
  workflow_dispatch:

jobs:
  macos-vnc-server:
    runs-on: macos-latest
    
    steps:
      - name: InformaciÃ³n del Sistema
        run: |
          echo "ðŸ–¥ï¸  macOS $(sw_vers -productVersion)"
          echo "ðŸ”§ $(uname -m)"
          xcodebuild -version
      
      - name: Instalar herramientas
        run: |
          brew install cloudflared
          echo "âœ… Cloudflare Tunnel instalado"
      
      - name: Instalar .NET MAUI
        run: |
          brew install --cask dotnet-sdk
          sudo dotnet workload install maui ios maccatalyst --skip-manifest-update
          echo "âœ… .NET MAUI listo"
      
      - name: Instalar Java y CocoaPods para KMP
        run: |
          brew install openjdk@17
          sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
          sudo gem install cocoapods
          echo "âœ… KMP dependencies listas"
      
      - name: Configurar Xcode
        run: |
          sudo xcodebuild -license accept
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          echo "âœ… Xcode configurado"
      
      - name: Configurar VNC con contraseÃ±a
        run: |
          # Crear contraseÃ±a para VNC (sin esto no puedes conectarte)
          VNC_PASSWORD="macos123"
          echo "runner:$VNC_PASSWORD" | sudo chpasswd
          
          # Habilitar ARD/VNC con configuraciÃ³n completa
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -restart -agent -privs -all \
            -allowAccessFor -allUsers \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD"
          
          echo "=========================================="
          echo "ðŸ” VNC CONFIGURADO"
          echo "=========================================="
          echo "ContraseÃ±a VNC: $VNC_PASSWORD"
          echo "=========================================="
      
      - name: Habilitar SSH
        run: |
          sudo systemsetup -setremotelogin on
          echo "âœ… SSH habilitado"
      
      - name: Iniciar tÃºnel Cloudflare para VNC
        run: |
          cloudflared tunnel --url tcp://localhost:5900 > cloudflare_vnc.log 2>&1 &
          sleep 10
          
          VNC_URL=$(grep -o 'https://.*\.trycloudflare.com' cloudflare_vnc.log | head -1)
          
          echo "=========================================="
          echo "ðŸŽ‰ CONEXIÃ“N VNC LISTA"
          echo "=========================================="
          echo ""
          echo "ðŸ“º URL VNC: $VNC_URL"
          echo ""
          echo "VNC_URL=$VNC_URL" >> $GITHUB_ENV
      
      - name: Iniciar tÃºnel Cloudflare para SSH
        run: |
          cloudflared tunnel --url tcp://localhost:22 > cloudflare_ssh.log 2>&1 &
          sleep 10
          
          SSH_URL=$(grep -o 'https://.*\.trycloudflare.com' cloudflare_ssh.log | head -1)
          
          echo "=========================================="
          echo "ðŸ” CONEXIÃ“N SSH LISTA"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ URL SSH: $SSH_URL"
          echo "ðŸ‘¤ Usuario: runner"
          echo ""
          echo "SSH_URL=$SSH_URL" >> $GITHUB_ENV
      
      - name: Usar tmate para acceso SSH
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 350
        with:
          detached: true
      
      - name: Mostrar instrucciones completas
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ CÃ“MO CONECTARTE DESDE WINDOWS"
          echo "=========================================="
          echo ""
          echo "ðŸ” CONTRASEÃ‘A VNC: macos123"
          echo ""
          echo "ðŸŽ¯ OPCIÃ“N 1 - SSH con Port Forwarding (RECOMENDADO)"
          echo "----------------------------------------"
          echo ""
          echo "Esta es la forma MÃS FÃCIL de ver los simuladores:"
          echo ""
          echo "1. Busca arriba en los logs el comando SSH de tmate"
          echo "   Se ve algo asÃ­: ssh xxxxx@nyc1.tmate.io"
          echo ""
          echo "2. En tu Windows PowerShell, ejecuta ese comando"
          echo ""
          echo "3. Una vez conectado por SSH, ejecuta:"
          echo "   open -a Simulator"
          echo "   xcrun simctl boot 'iPhone 15'"
          echo ""
          echo "4. Para ver el simulador en tu Windows, sal del SSH"
          echo "   y ejecuta (reemplaza con el comando real de tmate):"
          echo "   ssh -L 5900:localhost:5900 xxxxx@nyc1.tmate.io"
          echo ""
          echo "5. Ahora abre VNC Viewer y conecta a: localhost:5900"
          echo ""
          echo "=========================================="
          echo "ðŸŽ¯ OPCIÃ“N 2 - Usar Visual Studio desde Windows"
          echo "----------------------------------------"
          echo ""
          echo "Para compilar apps .NET MAUI desde tu Windows:"
          echo ""
          echo "1. ConÃ©ctate por SSH (comando tmate arriba)"
          echo ""
          echo "2. En Visual Studio 2022:"
          echo "   Tools > Options > Xamarin > iOS Settings"
          echo "   Add Mac > localhost:22"
          echo "   (despuÃ©s de hacer port forwarding SSH)"
          echo ""
          echo "3. Compila tu app desde Windows"
          echo ""
          echo "4. ConÃ©ctate por VNC para ver el simulador"
          echo ""
          echo "=========================================="
          echo "ðŸ’¡ RESUMEN SIMPLE"
          echo "=========================================="
          echo ""
          echo "1. Copia el comando SSH que aparece en los logs"
          echo "   (busca 'SSH session' arriba)"
          echo ""
          echo "2. EjecÃºtalo en tu PowerShell"
          echo ""
          echo "3. Ya tienes acceso al macOS!"
          echo ""
          echo "4. Para VER el escritorio:"
          echo "   - Sal del SSH"
          echo "   - Reconecta con: ssh -L 5900:localhost:5900 [comando-tmate]"
          echo "   - Abre VNC Viewer: localhost:5900"
          echo "   - ContraseÃ±a: macos123"
          echo ""
          echo "=========================================="
      
      - name: Abrir Simulator
        run: |
          echo "ðŸ“± Abriendo Simulator..."
          open -a Simulator
          sleep 5
          xcrun simctl boot "iPhone 15 Pro" || xcrun simctl boot "iPhone 15" || true
          echo "âœ… Simulator listo"
      
      - name: Crear guÃ­a en el escritorio
        run: |
          cat > ~/Desktop/INSTRUCCIONES.txt << 'GUIDE'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        ðŸŽ macOS GitHub Actions Remote          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ESTÃS CONECTADO AL SERVIDOR macOS REMOTO
          
          ðŸ“± SIMULADORES iOS:
          
          Ver simuladores disponibles:
            xcrun simctl list devices
          
          Abrir Simulator:
            open -a Simulator
          
          Iniciar iPhone 15:
            xcrun simctl boot "iPhone 15"
          
          ðŸ”§ HERRAMIENTAS:
          
          - Xcode: open -a Xcode
          - .NET: dotnet --version
          - Java: java -version
          - CocoaPods: pod --version
          
          ðŸ’» COMPILAR APPS:
          
          .NET MAUI:
            dotnet build -f net8.0-ios
            dotnet build -t:Run -f net8.0-ios
          
          Kotlin Multiplatform:
            ./gradlew linkDebugFrameworkIosSimulatorArm64
          
          ðŸŽ¯ CONSEJOS:
          
          - El Simulator ya deberÃ­a estar abierto
          - Usa Xcode para desarrollo nativo
          - Compila desde tu Windows y ve resultados aquÃ­
          
          GUIDE
          
          echo "âœ… GuÃ­a creada en ~/Desktop/INSTRUCCIONES.txt"
      
      - name: Mantener servidor activo
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸš€ SERVIDOR ACTIVO"
          echo "=========================================="
          echo ""
          echo "ðŸ“ PASOS RÃPIDOS:"
          echo ""
          echo "1. Busca arriba el comando 'ssh xxxxx@xxx.tmate.io'"
          echo "2. CÃ³pialo y ejecÃºtalo en tu Windows"
          echo "3. Â¡Ya tienes acceso al macOS!"
          echo ""
          echo "Para VNC (ver escritorio):"
          echo "- Usa: ssh -L 5900:localhost:5900 [el-comando-tmate]"
          echo "- Luego VNC Viewer: localhost:5900"
          echo "- ðŸ” ContraseÃ±a VNC: macos123"
          echo ""
          echo "ðŸ’¡ Cancela el workflow cuando termines"
          echo ""
          echo "=========================================="
          
          while true; do
            sleep 60
            
            # Mantener Simulator activo
            if ! pgrep -f Simulator > /dev/null; then
              open -a Simulator 2>/dev/null || true
            fi
            
            # Verificar tÃºneles Cloudflare
            if ! pgrep -f "cloudflared.*5900" > /dev/null; then
              cloudflared tunnel --url tcp://localhost:5900 > cloudflare_vnc.log 2>&1 &
            fi
            
            if ! pgrep -f "cloudflared.*22" > /dev/null; then
              cloudflared tunnel --url tcp://localhost:22 > cloudflare_ssh.log 2>&1 &
            fi
            
            echo "âœ“ $(date '+%H:%M:%S') - Servidor activo"
          done
      
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando..."
          pkill cloudflared || true
          sudo systemsetup -setremotelogin off
          echo "âœ… Limpieza completada"
