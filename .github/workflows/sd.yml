name: macOS VNC - Simuladores iOS (Gratis)

on:
  workflow_dispatch:

jobs:
  macos-vnc-server:
    runs-on: macos-latest
    
    steps:
      - name: InformaciÃ³n del Sistema
        run: |
          echo "ðŸ–¥ï¸  macOS $(sw_vers -productVersion)"
          echo "ðŸ”§ $(uname -m)"
          xcodebuild -version
      
      - name: Instalar herramientas
        run: |
          brew install cloudflared
          echo "âœ… Cloudflare Tunnel instalado"
      
      - name: Instalar .NET MAUI
        run: |
          brew install --cask dotnet-sdk
          sudo dotnet workload install maui ios maccatalyst --skip-manifest-update
          echo "âœ… .NET MAUI listo"
      
      - name: Instalar Java y CocoaPods para KMP
        run: |
          brew install openjdk@17
          sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
          sudo gem install cocoapods
          echo "âœ… KMP dependencies listas"
      
      - name: Configurar Xcode
        run: |
          sudo xcodebuild -license accept
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          echo "âœ… Xcode configurado"
      
      - name: Instalar noVNC para acceso web
        run: |
          brew install novnc websockify
          
          # Iniciar websockify en background
          websockify -D --web=/opt/homebrew/share/novnc/ 6080 localhost:5900
          
          echo "âœ… noVNC iniciado en puerto 6080"
      
      - name: Habilitar SSH
        run: |
          sudo systemsetup -setremotelogin on
          echo "âœ… SSH habilitado"
      
      - name: Iniciar tÃºnel Cloudflare para VNC
        run: |
          cloudflared tunnel --url tcp://localhost:5900 > cloudflare_vnc.log 2>&1 &
          sleep 10
          
          VNC_URL=$(grep -o 'https://.*\.trycloudflare.com' cloudflare_vnc.log | head -1)
          
          echo "=========================================="
          echo "ðŸŽ‰ CONEXIÃ“N VNC LISTA"
          echo "=========================================="
          echo ""
          echo "ðŸ“º URL VNC: $VNC_URL"
          echo ""
          echo "VNC_URL=$VNC_URL" >> $GITHUB_ENV
      
      - name: Iniciar tÃºnel Cloudflare para SSH
        run: |
          cloudflared tunnel --url tcp://localhost:22 > cloudflare_ssh.log 2>&1 &
          sleep 10
          
          SSH_URL=$(grep -o 'https://.*\.trycloudflare.com' cloudflare_ssh.log | head -1)
          
          echo "=========================================="
          echo "ðŸ” CONEXIÃ“N SSH LISTA"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ URL SSH: $SSH_URL"
          echo "ðŸ‘¤ Usuario: runner"
          echo ""
          echo "SSH_URL=$SSH_URL" >> $GITHUB_ENV
      
      - name: Usar tmate para acceso fÃ¡cil
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 1
        continue-on-error: true
      
      - name: Mostrar instrucciones completas
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ ACCESO AL ESCRITORIO macOS"
          echo "=========================================="
          echo ""
          echo "ðŸŒ MÃ‰TODO 1 - VNC en el NAVEGADOR (MÃS FÃCIL)"
          echo "----------------------------------------"
          echo ""
          echo "1. En tu sesiÃ³n SSH actual, ejecuta:"
          echo "   websockify --web=/opt/homebrew/share/novnc/ 6080 localhost:5900"
          echo ""
          echo "2. En otra terminal de Windows:"
          echo "   ssh -L 6080:localhost:6080 BxVPb8zZrSBVZjrfnq5nPtYpB@sfo2.tmate.io"
          echo ""
          echo "3. Abre tu navegador: http://localhost:6080/vnc.html"
          echo ""
          echo "4. Click en 'Connect'"
          echo ""
          echo "=========================================="
          echo "ðŸ–¥ï¸ MÃ‰TODO 2 - VNC Viewer (Alternativo)"
          echo "----------------------------------------"
          echo ""
          echo "En tu terminal actual (donde estÃ¡s conectado):"
          echo ""
          echo "1. Presiona: Enter"
          echo "2. Presiona: ~ (tecla ALT + 126)"
          echo "3. Presiona: C"
          echo "4. Escribe: -L 5900:localhost:5900"
          echo "5. Presiona Enter"
          echo ""
          echo "Luego abre VNC Viewer: localhost:5900"
          echo ""
          echo "=========================================="
      
      - name: Abrir Simulator
        run: |
          echo "ðŸ“± Abriendo Simulator..."
          open -a Simulator
          sleep 5
          xcrun simctl boot "iPhone 15 Pro" || xcrun simctl boot "iPhone 15" || true
          echo "âœ… Simulator listo"
      
      - name: Crear guÃ­a en el escritorio
        run: |
          cat > ~/Desktop/INSTRUCCIONES.txt << 'GUIDE'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        ðŸŽ macOS GitHub Actions Remote          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ESTÃS CONECTADO AL SERVIDOR macOS REMOTO
          
          ðŸ“± SIMULADORES iOS:
          
          Ver simuladores disponibles:
            xcrun simctl list devices
          
          Abrir Simulator:
            open -a Simulator
          
          Iniciar iPhone 15:
            xcrun simctl boot "iPhone 15"
          
          ðŸ”§ HERRAMIENTAS:
          
          - Xcode: open -a Xcode
          - .NET: dotnet --version
          - Java: java -version
          - CocoaPods: pod --version
          
          ðŸ’» COMPILAR APPS:
          
          .NET MAUI:
            dotnet build -f net8.0-ios
            dotnet build -t:Run -f net8.0-ios
          
          Kotlin Multiplatform:
            ./gradlew linkDebugFrameworkIosSimulatorArm64
          
          ðŸŽ¯ CONSEJOS:
          
          - El Simulator ya deberÃ­a estar abierto
          - Usa Xcode para desarrollo nativo
          - Compila desde tu Windows y ve resultados aquÃ­
          
          GUIDE
          
          echo "âœ… GuÃ­a creada en ~/Desktop/INSTRUCCIONES.txt"
      
      - name: Mantener servidor activo
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸš€ SERVIDOR ACTIVO"
          echo "=========================================="
          echo ""
          echo "ðŸ“ PASOS RÃPIDOS:"
          echo ""
          echo "1. Busca arriba el comando 'ssh xxxxx@xxx.tmate.io'"
          echo "2. CÃ³pialo y ejecÃºtalo en tu Windows"
          echo "3. Â¡Ya tienes acceso al macOS!"
          echo ""
          echo "Para VNC (ver escritorio):"
          echo "- Usa: ssh -L 5900:localhost:5900 [el-comando-tmate]"
          echo "- Luego VNC Viewer: localhost:5900"
          echo ""
          echo "ðŸ’¡ Cancela el workflow cuando termines"
          echo ""
          echo "=========================================="
          
          while true; do
            sleep 60
            
            # Mantener Simulator activo
            if ! pgrep -f Simulator > /dev/null; then
              open -a Simulator 2>/dev/null || true
            fi
            
            # Verificar tÃºneles Cloudflare
            if ! pgrep -f "cloudflared.*5900" > /dev/null; then
              cloudflared tunnel --url tcp://localhost:5900 > cloudflare_vnc.log 2>&1 &
            fi
            
            if ! pgrep -f "cloudflared.*22" > /dev/null; then
              cloudflared tunnel --url tcp://localhost:22 > cloudflare_ssh.log 2>&1 &
            fi
            
            echo "âœ“ $(date '+%H:%M:%S') - Servidor activo"
          done
      
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando..."
          pkill cloudflared || true
          sudo systemsetup -setremotelogin off
          echo "âœ… Limpieza completada"
