name: macOS 26 SSH - Visual Studio Pair to Mac

on:
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'Token de ngrok (obtÃ©n uno gratis en ngrok.com)'
        required: true
        type: string

jobs:
  macos-ssh-server:
    runs-on: macos-26
    
    steps:
      - name: InformaciÃ³n del Sistema
        run: |
          echo "ðŸ–¥ï¸  macOS $(sw_vers -productVersion)"
          echo "ðŸ”§ $(uname -m)"
          xcodebuild -version
      
      - name: Instalar .NET MAUI
        run: |
          brew install --cask dotnet-sdk
          sudo dotnet workload install maui ios maccatalyst --skip-manifest-update
          echo "âœ… .NET MAUI listo"
      
      - name: Instalar Java y CocoaPods para KMP
        run: |
          brew install openjdk@17
          sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
          sudo gem install cocoapods
          echo "âœ… KMP dependencies listas"
      
      - name: Configurar Xcode
        run: |
          sudo xcodebuild -license accept
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          echo "âœ… Xcode configurado"
      
      - name: Habilitar SSH y configurar usuario
        run: |
          # Habilitar Remote Login (SSH)
          sudo systemsetup -setremotelogin on
          
          # Crear contraseÃ±a para el usuario runner
          # MÃ©todo que funciona en GitHub Actions
          sudo security set-keychain-settings -t 3600 -u ~/Library/Keychains/login.keychain-db 2>/dev/null || true
          
          echo "âœ… SSH habilitado"
          echo ""
          echo "âš ï¸ IMPORTANTE: Configura la contraseÃ±a manualmente despuÃ©s de conectarte:"
          echo "   sudo passwd runner"
      
      - name: Instalar y configurar ngrok
        run: |
          # Instalar ngrok
          brew install ngrok
          
          # Configurar token de ngrok
          ngrok config add-authtoken ${{ inputs.ngrok_token }}
          
          echo "âœ… ngrok instalado y configurado"
      
      - name: Iniciar tÃºnel ngrok para SSH
        run: |
          # Iniciar ngrok en segundo plano
          ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          sleep 10
          
          # Obtener la URL de ngrok
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -oE 'tcp://[^"]+' | head -1)
          
          if [ -z "$NGROK_URL" ]; then
            echo "âŒ Error: No se pudo obtener la URL de ngrok"
            cat ngrok.log
            exit 1
          fi
          
          # Extraer host y puerto
          NGROK_HOST=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d: -f1)
          NGROK_PORT=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d: -f2)
          
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ TÃšNEL SSH LISTO PARA VISUAL STUDIO"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ URL completa: $NGROK_URL"
          echo "ðŸ–¥ï¸  Host: $NGROK_HOST"
          echo "ðŸ”Œ Puerto: $NGROK_PORT"
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ INSTRUCCIONES PARA VISUAL STUDIO 2022"
          echo "=========================================="
          echo ""
          echo "1. Abre Visual Studio 2022"
          echo "2. Ve a: Herramientas > iOS > Emparejar con Mac"
          echo "3. Clic en 'Agregar Mac...'"
          echo "4. Escribe: ${NGROK_HOST}:${NGROK_PORT}"
          echo "5. Usuario: runner"
          echo "6. ContraseÃ±a: (configÃºrala primero, ver abajo)"
          echo ""
          echo "=========================================="
          echo "âš ï¸ ANTES DE EMPAREJAR - Configura contraseÃ±a"
          echo "=========================================="
          echo ""
          echo "ConÃ©ctate por SSH primero:"
          echo "  ssh -p $NGROK_PORT runner@$NGROK_HOST"
          echo ""
          echo "Luego ejecuta:"
          echo "  sudo passwd runner"
          echo "  (Enter para old password, luego escribe: runner123)"
          echo ""
          echo "=========================================="
          
          # Guardar para uso posterior
          echo "NGROK_HOST=$NGROK_HOST" >> $GITHUB_ENV
          echo "NGROK_PORT=$NGROK_PORT" >> $GITHUB_ENV
      
      - name: Usar tmate como respaldo
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 350
        with:
          detached: true
      
      - name: Iniciar Simulator
        run: |
          echo "ðŸ“± Buscando simuladores disponibles..."
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -5
          
          # Obtener el UUID del iPhone 16 Pro
          DEVICE_UUID=$(xcrun simctl list devices available | grep "iPhone 16 Pro (" | head -1 | grep -oE '[A-F0-9-]{36}')
          
          if [ -n "$DEVICE_UUID" ]; then
            echo "ðŸ“± Iniciando iPhone 16 Pro: $DEVICE_UUID"
            xcrun simctl boot "$DEVICE_UUID" 2>/dev/null || true
            open -a Simulator
            sleep 5
            echo "âœ… Simulator iniciado"
          else
            echo "âš ï¸ No se encontrÃ³ iPhone 16 Pro, abriendo Simulator"
            open -a Simulator
          fi
      
      - name: Crear scripts de ayuda
        run: |
          mkdir -p ~/Screenshots
          
          cat > ~/screenshot.sh << 'SCRIPT'
          #!/bin/bash
          FILENAME="screen_$(date +%Y%m%d_%H%M%S).png"
          xcrun simctl io booted screenshot ~/Screenshots/$FILENAME
          echo "âœ… Screenshot: ~/Screenshots/$FILENAME"
          SCRIPT
          chmod +x ~/screenshot.sh
          
          cat > ~/info.sh << 'SCRIPT'
          #!/bin/bash
          echo "=========================================="
          echo "ðŸ“‹ INFORMACIÃ“N DE CONEXIÃ“N"
          echo "=========================================="
          curl -s http://localhost:4040/api/tunnels | grep -oE 'tcp://[^"]+' | head -1
          echo ""
          echo "Usuario: runner"
          echo "ContraseÃ±a: (la que configuraste con 'sudo passwd runner')"
          echo "=========================================="
          SCRIPT
          chmod +x ~/info.sh
          
          echo "âœ… Scripts creados: ~/screenshot.sh, ~/info.sh"
      
      - name: Mantener servidor activo
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸš€ SERVIDOR ACTIVO"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ SSH: ssh -p $NGROK_PORT runner@$NGROK_HOST"
          echo ""
          echo "ðŸ”— Para Visual Studio 2022:"
          echo "   Host: ${NGROK_HOST}:${NGROK_PORT}"
          echo "   Usuario: runner"
          echo ""
          echo "ðŸ“¸ Para screenshots: ~/screenshot.sh"
          echo "ðŸ“‹ Ver info: ~/info.sh"
          echo ""
          echo "ðŸ’¡ Cancela el workflow cuando termines"
          echo ""
          echo "=========================================="
          
          while true; do
            sleep 60
            
            # Verificar que ngrok siga activo
            if ! pgrep -f ngrok > /dev/null; then
              echo "âš ï¸ ngrok se detuvo, reiniciando..."
              ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
              sleep 5
            fi
            
            # Mantener Simulator activo
            if ! pgrep -f Simulator > /dev/null; then
              open -a Simulator 2>/dev/null || true
            fi
            
            echo "âœ“ $(date '+%H:%M:%S') - Servidor activo"
          done
      
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando..."
          pkill ngrok || true
          echo "âœ… Limpieza completada"
