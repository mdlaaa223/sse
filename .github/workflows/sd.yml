name: macOS 26 SSH - Visual Studio Pair to Mac

on:
  workflow_dispatch:

jobs:
  macos-ssh-server:
    runs-on: macos-26
    
    steps:
      - name: InformaciÃ³n del Sistema
        run: |
          echo "ðŸ–¥ï¸  macOS $(sw_vers -productVersion)"
          echo "ðŸ”§ $(uname -m)"
          xcodebuild -version
      
      - name: Instalar .NET MAUI
        run: |
          brew install --cask dotnet-sdk
          sudo dotnet workload install maui ios maccatalyst --skip-manifest-update
          echo "âœ… .NET MAUI listo"
      
      - name: Instalar Java y CocoaPods para KMP
        run: |
          brew install openjdk@17
          sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
          sudo gem install cocoapods
          echo "âœ… KMP dependencies listas"
      
      - name: Configurar Xcode
        run: |
          sudo xcodebuild -license accept
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          echo "âœ… Xcode configurado"
      
      - name: Habilitar SSH
        run: |
          sudo systemsetup -setremotelogin on
          echo "âœ… SSH habilitado"
      
      - name: Instalar bore (tÃºnel TCP gratuito)
        run: |
          # Instalar bore desde cargo
          brew install rust
          cargo install bore-cli
          echo "âœ… bore instalado"
      
      - name: Iniciar tÃºnel bore para SSH
        run: |
          # Agregar cargo bin al PATH
          export PATH="$HOME/.cargo/bin:$PATH"
          
          # Iniciar bore en segundo plano
          bore local 22 --to bore.pub > bore.log 2>&1 &
          sleep 10
          
          # Obtener el puerto asignado
          BORE_PORT=$(grep -oE 'remote port ([0-9]+)' bore.log | grep -oE '[0-9]+' | head -1)
          
          if [ -z "$BORE_PORT" ]; then
            echo "âš ï¸ No se pudo obtener el puerto de bore, mostrando log:"
            cat bore.log
            echo ""
            echo "Usando puerto por defecto..."
            BORE_PORT="N/A"
          fi
          
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ TÃšNEL SSH LISTO"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ Host: bore.pub"
          echo "ðŸ”Œ Puerto: $BORE_PORT"
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ PARA VISUAL STUDIO 2022"
          echo "=========================================="
          echo ""
          echo "1. Primero configura contraseÃ±a (ver tmate abajo)"
          echo "2. Luego en VS2022:"
          echo "   Herramientas > iOS > Emparejar con Mac"
          echo "   Host: bore.pub:$BORE_PORT"
          echo "   Usuario: runner"
          echo "   ContraseÃ±a: runner123"
          echo ""
          echo "=========================================="
          
          echo "BORE_PORT=$BORE_PORT" >> $GITHUB_ENV
      
      - name: Usar tmate para configuraciÃ³n inicial
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 350
        with:
          detached: true
      
      - name: Mostrar instrucciones completas
        run: |
          echo ""
          echo "=========================================="
          echo "âš ï¸ PASO IMPORTANTE: CONFIGURAR CONTRASEÃ‘A"
          echo "=========================================="
          echo ""
          echo "1. Busca arriba el comando: ssh xxxxx@xxx.tmate.io"
          echo "2. ConÃ©ctate desde PowerShell"
          echo "3. Ejecuta:"
          echo "   sudo passwd runner"
          echo "   Old password: [Enter]"
          echo "   New password: runner123"
          echo "   Confirm: runner123"
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ LUEGO EMPAREJA VISUAL STUDIO"
          echo "=========================================="
          echo ""
          echo "En VS2022 > Herramientas > iOS > Emparejar con Mac:"
          echo "   Host: bore.pub:$BORE_PORT"
          echo "   Usuario: runner"
          echo "   ContraseÃ±a: runner123"
          echo ""
          echo "=========================================="
      
      - name: Iniciar Simulator
        run: |
          echo "ðŸ“± Buscando simuladores disponibles..."
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -5
          
          DEVICE_UUID=$(xcrun simctl list devices available | grep "iPhone 16 Pro (" | head -1 | grep -oE '[A-F0-9-]{36}')
          
          if [ -n "$DEVICE_UUID" ]; then
            echo "ðŸ“± Iniciando iPhone 16 Pro: $DEVICE_UUID"
            xcrun simctl boot "$DEVICE_UUID" 2>/dev/null || true
            open -a Simulator
            sleep 5
            echo "âœ… Simulator iniciado"
          else
            open -a Simulator
          fi
      
      - name: Crear scripts de ayuda
        run: |
          mkdir -p ~/Screenshots
          
          cat > ~/screenshot.sh << 'SCRIPT'
          #!/bin/bash
          FILENAME="screen_$(date +%Y%m%d_%H%M%S).png"
          xcrun simctl io booted screenshot ~/Screenshots/$FILENAME
          echo "âœ… Screenshot: ~/Screenshots/$FILENAME"
          SCRIPT
          chmod +x ~/screenshot.sh
          
          echo "âœ… Script ~/screenshot.sh creado"
      
      - name: Mantener servidor activo
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          
          echo ""
          echo "=========================================="
          echo "ðŸš€ SERVIDOR ACTIVO"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ TÃºnel bore: bore.pub:$BORE_PORT"
          echo ""
          echo "ðŸ”— Para Visual Studio 2022:"
          echo "   Host: bore.pub:$BORE_PORT"
          echo "   Usuario: runner"
          echo "   ContraseÃ±a: runner123 (configÃºrala primero)"
          echo ""
          echo "âš ï¸ PRIMERO configura contraseÃ±a con tmate (ver arriba)"
          echo ""
          echo "ðŸ’¡ Cancela el workflow cuando termines"
          echo ""
          echo "=========================================="
          
          while true; do
            sleep 60
            
            # Verificar que bore siga activo
            if ! pgrep -f "bore local" > /dev/null; then
              echo "âš ï¸ bore se detuvo, reiniciando..."
              bore local 22 --to bore.pub > bore.log 2>&1 &
              sleep 5
            fi
            
            # Mantener Simulator activo
            if ! pgrep -f Simulator > /dev/null; then
              open -a Simulator 2>/dev/null || true
            fi
            
            echo "âœ“ $(date '+%H:%M:%S') - Servidor activo"
          done
      
      - name: Cleanup
        if: always()
        run: |
          pkill bore || true
          echo "âœ… Limpieza completada"
