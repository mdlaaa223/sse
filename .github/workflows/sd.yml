name: macOS con VNC - Simuladores iOS

on:
  workflow_dispatch:

jobs:
  macos-vnc-server:
    runs-on: macos-latest
    
    steps:
      - name: InformaciÃ³n del Sistema
        run: |
          echo "ðŸ–¥ï¸  macOS $(sw_vers -productVersion)"
          echo "ðŸ”§ $(uname -m)"
          xcodebuild -version
      
      - name: Instalar herramientas
        run: |
          brew install ngrok jq
          echo "âœ… Herramientas instaladas"
      
      - name: Instalar .NET MAUI
        run: |
          brew install --cask dotnet-sdk
          sudo dotnet workload install maui ios maccatalyst --skip-manifest-update
          echo "âœ… .NET MAUI listo"
      
      - name: Instalar Java y CocoaPods para KMP
        run: |
          brew install openjdk@17
          sudo ln -sfn /opt/homebrew/opt/openjdk@17/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk-17.jdk
          sudo gem install cocoapods
          echo "âœ… KMP dependencies listas"
      
      - name: Configurar Xcode y Simuladores
        run: |
          sudo xcodebuild -license accept
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          
          echo "ðŸ“± Simuladores iOS disponibles:"
          xcrun simctl list devices available | grep iPhone | head -5
          
          echo "âœ… Xcode configurado"
      
      - name: Configurar VNC (Screen Sharing)
        run: |
          # Habilitar VNC/Screen Sharing
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -restart -agent -privs -all \
            -allowAccessFor -allUsers
          
          # Configurar contraseÃ±a VNC
          # macOS usa un sistema de permisos, asÃ­ que configuramos de forma bÃ¡sica
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement.plist VNCLegacyConnectionsEnabled -bool true
          
          echo "âœ… VNC habilitado en puerto 5900"
      
      - name: Habilitar SSH
        run: |
          sudo systemsetup -setremotelogin on
          echo "âœ… SSH habilitado"
      
      - name: Configurar ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if [ -z "$NGROK_TOKEN" ]; then
            echo "âŒ NGROK_AUTH_TOKEN no configurado"
            exit 1
          fi
          ngrok config add-authtoken $NGROK_TOKEN
      
      - name: Iniciar tÃºnel VNC con ngrok
        run: |
          # TÃºnel para VNC (puerto 5900)
          ngrok tcp 5900 --log=stdout > ngrok_vnc.log &
          sleep 10
          
          VNC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          VNC_HOST=$(echo $VNC_URL | sed 's/tcp:\/\///' | cut -d':' -f1)
          VNC_PORT=$(echo $VNC_URL | sed 's/tcp:\/\///' | cut -d':' -f2)
          
          echo "VNC_HOST=$VNC_HOST" >> $GITHUB_ENV
          echo "VNC_PORT=$VNC_PORT" >> $GITHUB_ENV
          
          echo "=========================================="
          echo "ðŸŽ‰ CONEXIÃ“N VNC LISTA"
          echo "=========================================="
          echo ""
          echo "ðŸ“º Host: $VNC_HOST"
          echo "ðŸ“º Puerto: $VNC_PORT"
          echo ""
      
      - name: Iniciar tÃºnel SSH con ngrok
        run: |
          # TÃºnel para SSH (puerto 22)
          ngrok tcp 22 --log=stdout > ngrok_ssh.log &
          sleep 10
          
          SSH_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[1].public_url')
          SSH_HOST=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d':' -f1)
          SSH_PORT=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d':' -f2)
          
          echo "SSH_HOST=$SSH_HOST" >> $GITHUB_ENV
          echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV
          
          echo "=========================================="
          echo "ðŸ” CONEXIÃ“N SSH LISTA"
          echo "=========================================="
          echo ""
          echo "ðŸ“¡ Host: $SSH_HOST"
          echo "ðŸ“¡ Puerto: $SSH_PORT"
          echo "ðŸ‘¤ Usuario: runner"
          echo ""
      
      - name: Mostrar instrucciones completas
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ INSTRUCCIONES COMPLETAS"
          echo "=========================================="
          echo ""
          echo "ðŸªŸ OPCIÃ“N 1 - VNC VIEWER (Recomendado para ver simuladores)"
          echo "----------------------------------------"
          echo ""
          echo "1. Descarga VNC Viewer en Windows:"
          echo "   https://www.realvnc.com/en/connect/download/viewer/"
          echo ""
          echo "2. Abre VNC Viewer"
          echo ""
          echo "3. Conecta usando:"
          echo "   ${{ env.VNC_HOST }}:${{ env.VNC_PORT }}"
          echo ""
          echo "4. Si pide contraseÃ±a, presiona Enter (sin contraseÃ±a)"
          echo ""
          echo "5. Â¡VerÃ¡s el escritorio de macOS con Xcode y simuladores!"
          echo ""
          echo "=========================================="
          echo "ðŸ–¥ï¸ OPCIÃ“N 2 - USAR DESDE WINDOWS DIRECTAMENTE"
          echo "----------------------------------------"
          echo ""
          echo "Visual Studio 2022:"
          echo "  Tools > Options > Xamarin > iOS Settings"
          echo "  Add Mac: ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}"
          echo "  Username: runner"
          echo ""
          echo "Android Studio (KMP):"
          echo "  Settings > Kotlin Multiplatform > iOS Build Server"
          echo "  Host: ${{ env.SSH_HOST }}"
          echo "  Port: ${{ env.SSH_PORT }}"
          echo "  Username: runner"
          echo ""
          echo "=========================================="
          echo "ðŸ”§ OPCIÃ“N 3 - SSH para comandos"
          echo "----------------------------------------"
          echo ""
          echo "ssh runner@${{ env.SSH_HOST }} -p ${{ env.SSH_PORT }}"
          echo ""
          echo "Comandos Ãºtiles una vez conectado:"
          echo "  - Listar simuladores:"
          echo "    xcrun simctl list devices"
          echo ""
          echo "  - Abrir simulador iPhone 15:"
          echo "    open -a Simulator"
          echo "    xcrun simctl boot 'iPhone 15'"
          echo ""
          echo "  - Abrir Xcode:"
          echo "    open -a Xcode"
          echo ""
          echo "=========================================="
          echo "ðŸ’¡ MEJOR FORMA DE USAR"
          echo "=========================================="
          echo ""
          echo "1. ConÃ©ctate por VNC para VER los simuladores"
          echo "2. Usa Visual Studio/Android Studio en Windows"
          echo "3. Cuando compiles, verÃ¡s la app en el simulador"
          echo "   a travÃ©s de VNC"
          echo ""
          echo "O simplemente usa VNC y trabaja directamente"
          echo "en el macOS remoto con Xcode!"
          echo ""
          echo "=========================================="
      
      - name: Abrir Simulator automÃ¡ticamente
        run: |
          echo "ðŸ“± Abriendo Simulator..."
          
          # Abrir la app Simulator
          open -a Simulator
          
          # Esperar a que cargue
          sleep 5
          
          # Iniciar un iPhone 15 por defecto
          xcrun simctl boot "iPhone 15 Pro" || xcrun simctl boot "iPhone 15" || true
          
          echo "âœ… Simulator iniciado"
      
      - name: Crear script de ayuda
        run: |
          cat > ~/desktop-info.txt << 'INFO'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   ðŸŽ macOS GitHub Actions - Remote Desktop    â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EstÃ¡s conectado al servidor macOS remoto.
          
          ðŸ“± SIMULADORES iOS:
          - El Simulator ya estÃ¡ abierto
          - Usa: xcrun simctl list devices
          - Para abrir otro: open -a Simulator
          
          ðŸ”§ HERRAMIENTAS INSTALADAS:
          - Xcode
          - .NET SDK con MAUI
          - Java 17
          - CocoaPods
          - Homebrew
          
          ðŸ’» COMANDOS ÃšTILES:
          
          Ver simuladores disponibles:
            xcrun simctl list devices
          
          Iniciar un simulador:
            xcrun simctl boot "iPhone 15"
          
          Instalar app en simulador:
            xcrun simctl install booted MiApp.app
          
          Abrir URL en simulador:
            xcrun simctl openurl booted "https://ejemplo.com"
          
          Compilar proyecto .NET MAUI:
            dotnet build -f net8.0-ios
          
          Abrir Xcode:
            open -a Xcode
          
          ðŸŽ¯ DESARROLLO:
          - Puedes usar Xcode directamente aquÃ­
          - O compilar desde tu VS/Android Studio en Windows
          
          INFO
          
          cat ~/desktop-info.txt
      
      - name: Mantener servidor activo
        run: |
          echo ""
          echo "ðŸš€ Servidor macOS activo"
          echo "ðŸ“º Conecta VNC Viewer para ver el escritorio"
          echo "ðŸ’¡ Cancela el workflow cuando termines"
          echo ""
          
          while true; do
            sleep 60
            
            # Verificar tÃºneles
            if ! pgrep -f "ngrok tcp 5900" > /dev/null; then
              echo "âš ï¸  Reiniciando tÃºnel VNC..."
              ngrok tcp 5900 --log=stdout > ngrok_vnc.log &
              sleep 5
            fi
            
            if ! pgrep -f "ngrok tcp 22" > /dev/null; then
              echo "âš ï¸  Reiniciando tÃºnel SSH..."
              ngrok tcp 22 --log=stdout > ngrok_ssh.log &
              sleep 5
            fi
            
            # Mantener Simulator activo
            if ! pgrep -f Simulator > /dev/null; then
              open -a Simulator 2>/dev/null || true
            fi
            
            # Log periÃ³dico
            echo "âœ“ $(date '+%H:%M:%S') - Servidor activo"
          done
      
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Limpiando..."
          pkill ngrok || true
          sudo systemsetup -setremotelogin off
          echo "âœ… Servidor detenido"
