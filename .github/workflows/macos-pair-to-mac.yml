# ================================================================================
# GitHub Workflow: Pair to Mac - Conectar Visual Studio Windows con Mac remoto
# ================================================================================
# Este workflow crea un tÃºnel seguro para emparejar Visual Studio 2022/2026 
# con un Mac remoto de GitHub Actions para compilar apps iOS.
#
# Â¡Â¡ GRATIS - NO REQUIERE TARJETA DE CRÃ‰DITO !!
# Usa Cloudflare Tunnel (cloudflared) que es completamente gratuito.
#
# INSTRUCCIONES:
# 1. Configura los secrets en GitHub (Settings > Secrets > Actions):
#    - MAC_PASSWORD: ContraseÃ±a para el usuario del Mac
#
# 2. Ejecuta este workflow manualmente desde Actions
#
# 3. Espera a que aparezca la URL del tÃºnel en los logs
#
# 4. En tu Windows local, instala cloudflared:
#    winget install Cloudflare.cloudflared
#    o descarga de: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
#
# 5. Configura el tÃºnel en tu mÃ¡quina local (PowerShell):
#    cloudflared access tcp --hostname <URL_DEL_TUNEL> --url localhost:22
#
# 6. En Visual Studio: Tools > Options > Xamarin > iOS Settings
#    - Mac Host: localhost
#    - Port: 22
#    - Username: runner
#    - Password: (el que configuraste en MAC_PASSWORD)
#
# NOTA: El workflow dura mÃ¡ximo 6 horas (lÃ­mite de GitHub Actions)
# ================================================================================

name: ğŸ Pair to Mac (Visual Studio)

on:
  workflow_dispatch:
    inputs:
      tunnel_type:
        description: 'Tipo de tÃºnel'
        required: true
        default: 'ssh_and_vnc'
        type: choice
        options:
          - ssh
          - ssh_and_vnc
      create_gui_session:
        description: 'Crear sesiÃ³n GUI con tmate (mÃ¡s confiable)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true

jobs:
  pair-to-mac:
    name: ğŸ–¥ï¸ Mac disponible para emparejar
    runs-on: macos-26
    timeout-minutes: 360  # MÃ¡ximo 6 horas
    
    steps:
      # ============================================
      # 1. Checkout del cÃ³digo (opcional, para tener el proyecto)
      # ============================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ============================================
      # 2. Mostrar informaciÃ³n del sistema
      # ============================================
      - name: ğŸ“‹ InformaciÃ³n del Sistema
        run: |
          echo "============================================"
          echo "   INFORMACIÃ“N DEL MAC REMOTO"
          echo "============================================"
          echo ""
          echo "ğŸ–¥ï¸  macOS Version:"
          sw_vers
          echo ""
          echo "ğŸ’» Hardware:"
          system_profiler SPHardwareDataType | grep -E "Model|Processor|Memory|Cores"
          echo ""
          echo "ğŸ”§ Xcode Version:"
          xcodebuild -version
          echo ""
          echo "ğŸ“± iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios
          echo ""
          echo "ğŸ”· .NET SDK:"
          dotnet --version
          echo ""
          echo "ğŸ‘¤ Usuario actual:"
          whoami
          echo ""
          echo "ğŸ  Directorio home:"
          echo $HOME

      # ============================================
      # 3. Seleccionar Xcode con simuladores iOS
      # ============================================
      - name: ğŸ”§ Configurar Xcode con Simuladores iOS
        run: |
          echo "Buscando versiones de Xcode disponibles..."
          ls -la /Applications/ | grep Xcode
          
          # FunciÃ³n para verificar si Xcode tiene simuladores iOS
          check_ios_sims() {
            local xcode_path=$1
            if [ -d "$xcode_path" ]; then
              sudo xcode-select -s "$xcode_path/Contents/Developer"
              if xcrun simctl list devices available 2>/dev/null | grep -qi "iPhone"; then
                return 0
              fi
            fi
            return 1
          }
          
          # Buscar Xcode con simuladores iOS (probar varias versiones)
          XCODE_FOUND=false
          for xcode in /Applications/Xcode_26.0.app /Applications/Xcode_26.1.app /Applications/Xcode_26.2.app /Applications/Xcode.app; do
            if check_ios_sims "$xcode"; then
              echo "âœ… $xcode tiene simuladores iOS"
              XCODE_FOUND=true
              break
            else
              echo "âŒ $xcode no tiene simuladores iOS o no existe"
            fi
          done
          
          # Si ninguno tiene simuladores iOS, usar Xcode 26.2 e instalar runtime
          if [ "$XCODE_FOUND" = false ]; then
            echo ""
            echo "âš ï¸ NingÃºn Xcode tiene simuladores iOS preinstalados"
            echo "Seleccionando Xcode 26.2 y descargando iOS runtime..."
            
            if [ -d "/Applications/Xcode_26.2.app" ]; then
              sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
            elif [ -d "/Applications/Xcode_26.1.app" ]; then
              sudo xcode-select -s /Applications/Xcode_26.1.app/Contents/Developer
            elif [ -d "/Applications/Xcode.app" ]; then
              sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
            fi
            
            # Listar runtimes disponibles para descargar
            echo ""
            echo "Runtimes disponibles para descargar:"
            xcrun simctl runtime list 2>/dev/null || true
            
            # Intentar descargar iOS runtime
            echo ""
            echo "Intentando descargar iOS 26 runtime (esto puede tardar)..."
            xcrun simctl runtime add "iOS 26.0" 2>/dev/null || \
            xcrun simctl runtime add "com.apple.CoreSimulator.SimRuntime.iOS-26-0" 2>/dev/null || \
            xcodebuild -downloadPlatform iOS 2>/dev/null || \
            echo "No se pudo descargar automÃ¡ticamente. Continuando sin simulador iOS."
          fi
          
          echo ""
          echo "Xcode seleccionado:"
          xcodebuild -version
          echo ""
          echo "iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios || echo "No hay iOS SDKs"
          echo ""
          echo "Simuladores iOS disponibles:"
          xcrun simctl list devices available | grep -i iphone || echo "No hay simuladores iPhone"
          echo ""
          echo "Todos los simuladores:"
          xcrun simctl list devices available | head -30

      # ============================================
      # 4. Instalar .NET MAUI workloads
      # ============================================
      - name: ğŸ“¦ Instalar .NET MAUI Workloads
        run: |
          echo "Instalando workloads de MAUI..."
          dotnet workload install maui
          echo ""
          echo "âœ… Workloads instalados:"
          dotnet workload list

      # ============================================
      # 4.1 Preparar Simulador de iOS (IMPORTANTE para VS remoto)
      # ============================================
      - name: ğŸ“± Preparar Simulador de iOS
        continue-on-error: true
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  PREPARANDO SIMULADOR DE iOS PARA VISUAL STUDIO REMOTO          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Listar todos los simuladores disponibles
          echo "Simuladores disponibles:"
          xcrun simctl list devices available
          echo ""
          
          # Buscar simuladores iPhone
          echo "Buscando simuladores iPhone..."
          IPHONE_SIMS=$(xcrun simctl list devices available | grep -i "iPhone" || echo "")
          
          if [ -z "$IPHONE_SIMS" ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âš ï¸  NO HAY SIMULADORES iPHONE DISPONIBLES                       â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  El runner de GitHub Actions no tiene iOS runtime instalado.    â•‘"
            echo "â•‘                                                                   â•‘"
            echo "â•‘  OPCIONES:                                                       â•‘"
            echo "â•‘  1. Conectar por VNC y descargar manualmente desde Xcode        â•‘"
            echo "â•‘     Xcode > Settings > Platforms > iOS > Download               â•‘"
            echo "â•‘                                                                   â•‘"
            echo "â•‘  2. Usar dispositivo fÃ­sico conectado al Mac                    â•‘"
            echo "â•‘                                                                   â•‘"
            echo "â•‘  3. El Pair to Mac funcionarÃ¡ para compilaciÃ³n aunque           â•‘"
            echo "â•‘     el simulador remoto no estÃ© disponible.                     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Intentando descargar iOS platform..."
            xcodebuild -downloadPlatform iOS 2>&1 || echo "Descarga no disponible o requiere Apple ID"
            
            # Guardar estado
            echo "SIMULATOR_UDID=" >> $GITHUB_ENV
            echo "IOS_SIMULATOR_AVAILABLE=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Simuladores iPhone encontrados:"
          echo "$IPHONE_SIMS"
          echo ""
          
          # Obtener el UDID del primer iPhone disponible con iOS 26
          SIMULATOR_UDID=$(echo "$IPHONE_SIMS" | grep -i "26" | head -1 | grep -oE '[A-F0-9-]{36}' || echo "")
          
          if [ -z "$SIMULATOR_UDID" ]; then
            # Si no hay iOS 26, buscar cualquier iPhone
            SIMULATOR_UDID=$(echo "$IPHONE_SIMS" | head -1 | grep -oE '[A-F0-9-]{36}' || echo "")
          fi
          
          if [ -n "$SIMULATOR_UDID" ]; then
            echo "Simulador encontrado: $SIMULATOR_UDID"
            
            # Iniciar el simulador en background
            echo "Iniciando simulador..."
            xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || echo "Simulador ya iniciado o no disponible"
            
            # Abrir la app Simulator (esto es necesario para el streaming remoto)
            echo "Abriendo aplicaciÃ³n Simulator..."
            open -a Simulator --background 2>/dev/null || true
            
            # Esperar a que el simulador estÃ© listo
            sleep 5
            
            # Verificar estado
            echo ""
            echo "Estado del simulador:"
            xcrun simctl list devices booted
            
            echo ""
            echo "âœ… Simulador preparado: $SIMULATOR_UDID"
            echo "IOS_SIMULATOR_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ No se pudo obtener UDID del simulador"
            echo "IOS_SIMULATOR_AVAILABLE=false" >> $GITHUB_ENV
          fi
          
          # Guardar UDID para referencia
          echo "SIMULATOR_UDID=$SIMULATOR_UDID" >> $GITHUB_ENV

      # ============================================
      # 5. Configurar SSH para conexiÃ³n remota
      # ============================================
      - name: ğŸ” Configurar SSH y Acceso Remoto
        id: ssh_config
        run: |
          echo "Configurando SSH..."
          
          # ContraseÃ±a fija para facilitar la conexiÃ³n
          PASSWORD="Runner123"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # CONFIGURAR CONTRASEÃ‘A PARA 'runner' (usuario con GUI activa)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "Configurando contraseÃ±a para usuario 'runner'..."
          
          # MÃ©todo 1: sysadminctl (mÃ¡s confiable en macOS modernos)
          sudo sysadminctl -resetPasswordFor runner -newPassword "$PASSWORD" -passwordHint "pair" 2>/dev/null && \
            echo "âœ… ContraseÃ±a de 'runner' configurada con sysadminctl" || {
            
            # MÃ©todo 2: dscl
            echo "Intentando con dscl..."
            sudo dscl . -passwd /Users/runner "$PASSWORD" 2>/dev/null && \
              echo "âœ… ContraseÃ±a de 'runner' configurada con dscl" || {
              
              # MÃ©todo 3: passwd interactivo con expect
              echo "Intentando con passwd..."
              echo "$PASSWORD\n$PASSWORD" | sudo passwd runner 2>/dev/null && \
                echo "âœ… ContraseÃ±a de 'runner' configurada con passwd" || \
                echo "âš ï¸ No se pudo configurar contraseÃ±a de runner"
            }
          }
          
          # Verificar que runner puede autenticarse
          echo ""
          echo "Verificando autenticaciÃ³n de 'runner'..."
          if dscl . -authonly runner "$PASSWORD" 2>/dev/null; then
            echo "âœ… Usuario 'runner' puede autenticarse con contraseÃ±a '$PASSWORD'"
            RUNNER_AUTH_OK=true
          else
            echo "âš ï¸ Usuario 'runner' NO puede autenticarse - usar 'macuser' en su lugar"
            RUNNER_AUTH_OK=false
          fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # CREAR USUARIO 'macuser' (alternativa confiable)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Crear un nuevo usuario para SSH (mÃ¡s confiable que modificar runner)
          if ! id "macuser" &>/dev/null; then
            echo "Creando usuario 'macuser' para SSH..."
            sudo sysadminctl -addUser macuser -password "$PASSWORD" -admin
          else
            echo "Usuario macuser ya existe"
            # Asegurar que la contraseÃ±a estÃ¡ configurada
            sudo sysadminctl -resetPasswordFor macuser -newPassword "$PASSWORD" -passwordHint "pair" 2>/dev/null || true
          fi
          
          # Verificar autenticaciÃ³n de macuser
          echo ""
          echo "Verificando autenticaciÃ³n de 'macuser'..."
          if dscl . -authonly macuser "$PASSWORD" 2>/dev/null; then
            echo "âœ… Usuario 'macuser' puede autenticarse con contraseÃ±a '$PASSWORD'"
            MACUSER_AUTH_OK=true
          else
            echo "âš ï¸ Usuario 'macuser' NO puede autenticarse"
            MACUSER_AUTH_OK=false
          fi
          
          # Guardar estado de autenticaciÃ³n
          echo "RUNNER_AUTH_OK=$RUNNER_AUTH_OK" >> $GITHUB_ENV
          echo "MACUSER_AUTH_OK=$MACUSER_AUTH_OK" >> $GITHUB_ENV
          
          # Dar permisos de administrador al usuario
          sudo dseditgroup -o edit -a macuser -t user admin
          sudo dseditgroup -o edit -a macuser -t user wheel
          
          # Habilitar login remoto (SSH)
          sudo systemsetup -setremotelogin on
          
          # Configurar SSH para permitir autenticaciÃ³n por contraseÃ±a
          sudo sed -i '' 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^KbdInteractiveAuthentication no/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#UsePAM.*/UsePAM yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^UsePAM no/UsePAM yes/' /etc/ssh/sshd_config
          
          # Agregar configuraciones explÃ­citas
          cat << 'EOF' | sudo tee -a /etc/ssh/sshd_config
          
          # ConfiguraciÃ³n para Pair to Mac
          PasswordAuthentication yes
          KbdInteractiveAuthentication yes
          UsePAM yes
          PermitRootLogin no
          EOF
          
          # Reiniciar servicio SSH
          sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
          
          # Verificar que SSH estÃ¡ funcionando
          sleep 2
          if sudo lsof -i :22 | grep -q LISTEN; then
            echo "âœ… SSH estÃ¡ escuchando en puerto 22"
          else
            echo "âš ï¸ Intentando iniciar SSH de otra manera..."
            sudo launchctl start com.openssh.sshd || true
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  CREDENCIALES DE ACCESO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ‘¤ Usuario:     macuser"
          echo "  ğŸ”‘ ContraseÃ±a:  $PASSWORD"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Guardar para usar despuÃ©s
          echo "MAC_USER=macuser" >> $GITHUB_ENV
          echo "MAC_PASS=$PASSWORD" >> $GITHUB_ENV

      # ============================================
      # 5.1 Crear sesiÃ³n de usuario (requerido para Pair to Mac)
      # ============================================
      - name: ğŸ‘¤ Crear SesiÃ³n de Usuario para Pair to Mac
        run: |
          echo "Creando sesiÃ³n de usuario para Visual Studio Pair to Mac..."
          
          PASSWORD="Runner123"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 1: Configurar contraseÃ±a para 'runner' usando sysadminctl
          # El usuario 'runner' YA tiene sesiÃ³n GUI activa en GitHub Actions
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Intentando configurar contraseÃ±a para 'runner'..."
          
          # MÃ©todo A: Usar sysadminctl para crear/resetear contraseÃ±a
          # En macOS, podemos usar -adminUser con el usuario actual si tiene permisos
          sudo sysadminctl -resetPasswordFor runner -newPassword "$PASSWORD" -passwordHint "pair" 2>/dev/null || {
            echo "MÃ©todo A fallÃ³, intentando mÃ©todo B..."
            
            # MÃ©todo B: Usar dscl con SecureToken
            sudo dscl . -passwd /Users/runner "" "$PASSWORD" 2>/dev/null || {
              echo "MÃ©todo B fallÃ³, intentando mÃ©todo C..."
              
              # MÃ©todo C: Crear entrada de contraseÃ±a directamente
              sudo security set-keychain-password -o "" -p "$PASSWORD" /Users/runner/Library/Keychains/login.keychain-db 2>/dev/null || true
            }
          }
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 2: Crear sesiÃ³n GUI real para 'macuser'
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Configurando sesiÃ³n GUI para 'macuser'..."
          
          MACUSER_UID=$(id -u macuser)
          RUNNER_UID=$(id -u runner)
          echo "UID de macuser: $MACUSER_UID"
          echo "UID de runner: $RUNNER_UID"
          
          # Crear el directorio home completo para macuser
          sudo mkdir -p /Users/macuser/Library/Preferences
          sudo mkdir -p /Users/macuser/Library/LaunchAgents
          sudo mkdir -p /Users/macuser/Library/Caches
          sudo chown -R macuser:staff /Users/macuser
          
          # Copiar configuraciones bÃ¡sicas desde runner
          sudo cp -R /Users/runner/Library/Preferences/* /Users/macuser/Library/Preferences/ 2>/dev/null || true
          sudo chown -R macuser:staff /Users/macuser/Library/Preferences
          
          # Habilitar auto-login para macuser (esto ayuda a crear la sesiÃ³n)
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser macuser
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUserUID $MACUSER_UID
          
          # Crear el bootstrap GUI para macuser
          sudo launchctl bootstrap gui/$MACUSER_UID /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
          sudo launchctl asuser $MACUSER_UID launchctl load -S Aqua /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
          
          # Iniciar una sesiÃ³n de login para macuser
          # Esto simula un login grÃ¡fico
          sudo /System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow console $MACUSER_UID 2>/dev/null &
          sleep 3
          
          # Configurar Remote Management para ambos usuarios
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -users macuser,runner \
            -privs -all \
            -restart -agent 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 3: Iniciar el Broker de XMA (Xamarin Mac Agent)
          # Este es el servicio que Visual Studio busca
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Preparando Xamarin Mac Agent para ambos usuarios..."
          
          # El XMA Broker necesita correr como el usuario conectado
          # Creamos un script que lo inicia para macuser
          
          cat << 'SCRIPT' | sudo tee /tmp/start_xma_session.sh
          #!/bin/bash
          # Iniciar sesiÃ³n de usuario para XMA
          export HOME=/Users/macuser
          export USER=macuser
          export LOGNAME=macuser
          
          # Crear el archivo de sesiÃ³n que XMA busca
          mkdir -p /Users/macuser/Library/Application\ Support/Xamarin
          touch /Users/macuser/Library/Application\ Support/Xamarin/.session
          
          # Mantener la sesiÃ³n activa
          while true; do
            sleep 60
          done
          SCRIPT
          
          sudo chmod +x /tmp/start_xma_session.sh
          sudo -u macuser /tmp/start_xma_session.sh &
          
          # TambiÃ©n para runner
          mkdir -p "/Users/runner/Library/Application Support/Xamarin" 2>/dev/null || true
          touch "/Users/runner/Library/Application Support/Xamarin/.session" 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 4: Forzar creaciÃ³n de sesiÃ³n GUI usando launchd
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Crear un LaunchAgent que mantiene viva la sesiÃ³n
          cat << 'PLIST' | sudo tee /Library/LaunchDaemons/com.github.usersession.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>com.github.usersession</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/bin/bash</string>
                  <string>-c</string>
                  <string>launchctl asuser 502 /bin/bash -c "export HOME=/Users/macuser; while true; do sleep 60; done"</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              <key>UserName</key>
              <string>root</string>
          </dict>
          </plist>
          PLIST
          
          sudo launchctl load /Library/LaunchDaemons/com.github.usersession.plist 2>/dev/null || true
          
          # Verificar sesiones
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Sesiones activas despuÃ©s de configuraciÃ³n:"
          who -a 2>/dev/null || true
          echo ""
          echo "Procesos de loginwindow:"
          ps aux | grep -i loginwindow | grep -v grep || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo ""
          echo "âœ… ConfiguraciÃ³n de sesiÃ³n completada"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  IMPORTANTE: Si 'macuser' sigue sin funcionar, usa 'runner'    â•‘"
          echo "â•‘  pero deberÃ¡s probar si la contraseÃ±a se configurÃ³ bien.       â•‘"
          echo "â•‘                                                                 â•‘"
          echo "â•‘  Usuario: macuser  |  ContraseÃ±a: Runner123                    â•‘"
          echo "â•‘  Usuario: runner   |  ContraseÃ±a: Runner123 (si funcionÃ³)      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 5.2 Iniciar Simulador en sesiÃ³n de macuser
      # ============================================
      - name: ğŸ“± Iniciar Simulador iOS para Streaming Remoto
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  INICIANDO SIMULADOR iOS PARA VISUAL STUDIO REMOTO              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          MACUSER_UID=$(id -u macuser)
          
          # Obtener el UDID del simulador
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iPhone" | grep -i "26" | head -1 | grep -oE '[A-F0-9-]{36}')
          
          if [ -z "$SIMULATOR_UDID" ]; then
            SIMULATOR_UDID=$(xcrun simctl list devices available | grep -i "iPhone" | head -1 | grep -oE '[A-F0-9-]{36}')
          fi
          
          if [ -n "$SIMULATOR_UDID" ]; then
            echo "Simulador: $SIMULATOR_UDID"
            
            # Iniciar el simulador como macuser (importante para el streaming)
            echo "Iniciando simulador como macuser..."
            sudo -u macuser xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || echo "Simulador ya booteado"
            
            # Abrir la aplicaciÃ³n Simulator como macuser
            echo "Abriendo aplicaciÃ³n Simulator como macuser..."
            sudo launchctl asuser $MACUSER_UID open -a Simulator 2>/dev/null || {
              sudo -u macuser open -a Simulator 2>/dev/null || true
            }
            
            # Esperar a que el simulador estÃ© completamente listo
            echo "Esperando a que el simulador estÃ© listo..."
            sleep 10
            
            # Verificar que el simulador estÃ¡ corriendo
            echo ""
            echo "Simuladores booteados:"
            xcrun simctl list devices booted
            
            # Verificar procesos del simulador
            echo ""
            echo "Procesos del simulador:"
            ps aux | grep -i simulator | grep -v grep | head -5 || echo "NingÃºn proceso visible"
            
            echo ""
            echo "âœ… Simulador iniciado y listo para streaming remoto"
          else
            echo "âš ï¸ No se pudo encontrar un simulador de iPhone"
          fi

      # ============================================
      # 6. Configurar VNC (si se selecciona)
      # ============================================
      - name: ğŸ–¥ï¸ Configurar VNC/Screen Sharing
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Configurando VNC/Screen Sharing..."
          
          PASSWORD="Runner123"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # IMPORTANTE: GitHub Actions solo tiene GUI para 'runner'
          # VNC mostrarÃ¡ el escritorio de 'runner', no de 'macuser'
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Habilitar Screen Sharing (VNC) con configuraciÃ³n completa
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$PASSWORD" \
            -restart -agent -privs -all
          
          # Configurar Screen Sharing directamente
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Asegurar que el display estÃ¡ activo (evita pantalla negra)
          echo "Activando display..."
          caffeinate -u -t 5 &
          
          # Iniciar Finder y Dock para que haya un escritorio visible
          echo "Iniciando entorno de escritorio..."
          open -a Finder
          sleep 2
          
          # Abrir una ventana de Terminal para que se vea algo
          osascript -e 'tell application "Terminal" to activate' 2>/dev/null || true
          
          # Desactivar el protector de pantalla y sleep
          sudo pmset -a displaysleep 0
          sudo pmset -a sleep 0
          defaults write com.apple.screensaver askForPassword 0
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  VNC CONFIGURADO - CONECTA AL ESCRITORIO DE 'runner'           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  El VNC muestra el escritorio del usuario 'runner'             â•‘"
          echo "â•‘  que es el Ãºnico con sesiÃ³n GUI real en GitHub Actions.        â•‘"
          echo "â•‘                                                                 â•‘"
          echo "â•‘  Desde el escritorio VNC puedes:                               â•‘"
          echo "â•‘  - Abrir Terminal y cambiar a macuser: su - macuser            â•‘"
          echo "â•‘  - Ejecutar el Simulador: open -a Simulator                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… VNC/Screen Sharing habilitado"
          echo "ğŸ–¥ï¸ Puerto VNC: 5900"
          echo "ğŸ”‘ ContraseÃ±a VNC: $PASSWORD"
          echo "ğŸ‘¤ Usuario del escritorio: runner"

      # ============================================
      # 6.1 Mantener Display Activo (evitar pantalla negra)
      # ============================================
      - name: ğŸ–¥ï¸ Mantener Display Activo
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Configurando display para evitar pantalla negra..."
          
          # Desactivar ahorro de energÃ­a completamente
          sudo pmset -a displaysleep 0
          sudo pmset -a sleep 0
          sudo pmset -a disksleep 0
          sudo pmset -a powernap 0
          
          # Mantener el display activo con caffeinate en background
          nohup caffeinate -d -i -s -u &
          echo "CAFFEINATE_PID=$!" >> $GITHUB_ENV
          
          # Desactivar protector de pantalla
          defaults -currentHost write com.apple.screensaver idleTime 0
          defaults write com.apple.screensaver askForPassword 0
          
          # Asegurar que hay actividad en el display
          # Esto "despierta" el display
          osascript -e 'tell application "System Events" to keystroke " "' 2>/dev/null || true
          
          # Abrir algunas apps para que el escritorio no estÃ© vacÃ­o
          open -a Finder
          open -a Terminal
          
          # Crear un script que mantiene el mouse moviÃ©ndose
          cat << 'KEEPALIVE' | tee /tmp/keep_display_alive.sh
          #!/bin/bash
          while true; do
            # Simular actividad del mouse cada 60 segundos
            osascript -e 'tell application "System Events" to key code 63' 2>/dev/null || true
            sleep 60
          done
          KEEPALIVE
          chmod +x /tmp/keep_display_alive.sh
          nohup /tmp/keep_display_alive.sh &
          
          echo "âœ… Display configurado para mantenerse activo"

      # ============================================
      # 6.2 SesiÃ³n interactiva con tmate (mÃ¡s confiable)
      # ============================================
      - name: ğŸ”§ Configurar SesiÃ³n Interactiva con tmate
        if: ${{ github.event.inputs.create_gui_session == 'true' }}
        run: |
          echo "Instalando tmate para sesiÃ³n interactiva..."
          brew install tmate
          
          # Crear script para login de macuser
          cat << 'LOGINSCRIPT' | sudo tee /tmp/login_macuser.sh
          #!/bin/bash
          # Script para iniciar sesiÃ³n como macuser
          echo "==================================="
          echo "Iniciando sesiÃ³n como macuser..."
          echo "==================================="
          su - macuser -c "
            export HOME=/Users/macuser
            cd ~
            # Crear marcador de sesiÃ³n para XMA
            mkdir -p ~/Library/Application\ Support/Xamarin
            touch ~/Library/Application\ Support/Xamarin/.session
            echo 'SesiÃ³n de macuser iniciada'
            # Mantener sesiÃ³n activa
            exec bash
          "
          LOGINSCRIPT
          sudo chmod +x /tmp/login_macuser.sh
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  SESIÃ“N TMATE DISPONIBLE                                         â•‘"
          echo "â•‘  Usa esta sesiÃ³n para hacer login manual como macuser            â•‘"
          echo "â•‘  y luego probar Pair to Mac desde Visual Studio                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 7. Instalar Cloudflare Tunnel
      # ============================================
      - name: â˜ï¸ Instalar Cloudflare Tunnel
        run: |
          echo "Instalando cloudflared..."
          brew install cloudflare/cloudflare/cloudflared
          cloudflared --version
          echo "âœ… Cloudflared instalado"

      # ============================================
      # 8. Iniciar tÃºnel SSH
      # ============================================
      - name: ğŸš‡ Iniciar TÃºnel SSH
        id: ssh_tunnel
        run: |
          echo "Iniciando tÃºnel SSH con Cloudflare..."
          
          # Iniciar tÃºnel en background
          nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
          SSH_TUNNEL_PID=$!
          echo "SSH_TUNNEL_PID=$SSH_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el tÃºnel estÃ© listo
          echo "Esperando a que el tÃºnel estÃ© listo..."
          sleep 15
          
          # Obtener URL del tÃºnel
          SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "")
          
          if [ -z "$SSH_TUNNEL_URL" ]; then
            echo "Reintentando obtener URL..."
            sleep 10
            SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "URL_NO_DISPONIBLE")
          fi
          
          # Convertir a hostname sin https://
          SSH_TUNNEL_HOST=$(echo "$SSH_TUNNEL_URL" | sed 's|https://||')
          
          echo "SSH_TUNNEL_URL=$SSH_TUNNEL_URL" >> $GITHUB_ENV
          echo "SSH_TUNNEL_HOST=$SSH_TUNNEL_HOST" >> $GITHUB_ENV
          echo "ssh_url=$SSH_TUNNEL_HOST" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… TÃºnel SSH iniciado"
          echo "ğŸ”— URL: $SSH_TUNNEL_URL"

      # ============================================
      # 9. Iniciar tÃºnel VNC (si se selecciona)
      # ============================================
      - name: ğŸš‡ Iniciar TÃºnel VNC
        id: vnc_tunnel
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Iniciando tÃºnel VNC con Cloudflare..."
          
          # Iniciar tÃºnel en background
          nohup cloudflared tunnel --url tcp://localhost:5900 --logfile /tmp/vnc_tunnel.log 2>&1 &
          VNC_TUNNEL_PID=$!
          echo "VNC_TUNNEL_PID=$VNC_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el tÃºnel estÃ© listo
          sleep 15
          
          # Obtener URL del tÃºnel
          VNC_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/vnc_tunnel.log || echo "URL_NO_DISPONIBLE")
          VNC_TUNNEL_HOST=$(echo "$VNC_TUNNEL_URL" | sed 's|https://||')
          
          echo "VNC_TUNNEL_URL=$VNC_TUNNEL_URL" >> $GITHUB_ENV
          echo "VNC_TUNNEL_HOST=$VNC_TUNNEL_HOST" >> $GITHUB_ENV
          
          echo ""
          echo "âœ… TÃºnel VNC iniciado"
          echo "ğŸ”— URL: $VNC_TUNNEL_URL"

      # ============================================
      # 10. Mostrar instrucciones de conexiÃ³n
      # ============================================
      - name: ğŸ“‹ Instrucciones de ConexiÃ³n
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ MAC REMOTO LISTO PARA EMPAREJAR CON VISUAL STUDIO ğŸ        â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    INFORMACIÃ“N DE CONEXIÃ“N"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”— TÃºnel SSH:     $SSH_TUNNEL_URL"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  USUARIOS DISPONIBLES:                                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          if [ "$RUNNER_AUTH_OK" = "true" ]; then
            echo "â•‘  âœ… runner    - ContraseÃ±a: Runner123 (VERIFICADA)              â•‘"
          else
            echo "â•‘  âš ï¸  runner    - ContraseÃ±a: Runner123 (NO VERIFICADA)           â•‘"
          fi
          if [ "$MACUSER_AUTH_OK" = "true" ]; then
            echo "â•‘  âœ… macuser   - ContraseÃ±a: Runner123 (VERIFICADA)              â•‘"
          else
            echo "â•‘  âš ï¸  macuser   - ContraseÃ±a: Runner123 (NO VERIFICADA)           â•‘"
          fi
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ’¡ Usa el usuario con âœ… para Pair to Mac                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          if [ "$IOS_SIMULATOR_AVAILABLE" = "true" ]; then
            echo "â•‘  âœ… SIMULADOR iOS: DISPONIBLE                                   â•‘"
            echo "â•‘     UDID: $SIMULATOR_UDID"
          else
            echo "â•‘  âš ï¸  SIMULADOR iOS: NO DISPONIBLE                                â•‘"
            echo "â•‘     El runner no tiene iOS runtime instalado.                   â•‘"
            echo "â•‘     Puedes compilar pero no usar simulador remoto.              â•‘"
            echo "â•‘     ConÃ©ctate por VNC y descarga iOS desde Xcode > Platforms    â•‘"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â±ï¸  DuraciÃ³n:      Hasta que canceles el workflow manualmente"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "ğŸ–¥ï¸  TÃºnel VNC:     $VNC_TUNNEL_URL"
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           PASOS PARA CONECTAR DESDE WINDOWS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¥ PASO 1: Instalar cloudflared en tu Windows"
          echo "   Abre PowerShell como Administrador y ejecuta:"
          echo ""
          echo "   winget install Cloudflare.cloudflared"
          echo ""
          echo "   O descarga manualmente de:"
          echo "   https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "ğŸ”Œ PASO 2: Crear tÃºnel local (PowerShell)"
          echo "   Ejecuta este comando para crear el tÃºnel:"
          echo ""
          echo "   cloudflared access tcp --hostname $SSH_TUNNEL_HOST --url localhost:2222"
          echo ""
          echo "   âš ï¸  MantÃ©n esta ventana abierta mientras uses el Mac"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "ğŸ”§ PASO 3: Configurar Visual Studio"
          echo ""
          echo "   A) Ve a: Tools > Options > Xamarin > iOS Settings"
          echo ""
          echo "   B) En 'Pair to Mac', configura:"
          echo "      â€¢ Host:     localhost"
          echo "      â€¢ Port:     2222"
          echo ""
          echo "   C) Haz clic en 'Pair' e ingresa:"
          echo "      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "      â”‚  ğŸ‘‰ PRUEBA PRIMERO CON:                     â”‚"
          echo "      â”‚     Username: runner                        â”‚"
          echo "      â”‚     Password: Runner123                     â”‚"
          echo "      â”‚                                             â”‚"
          echo "      â”‚  Si no funciona, intenta con:               â”‚"
          echo "      â”‚     Username: macuser                       â”‚"
          echo "      â”‚     Password: Runner123                     â”‚"
          echo "      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "âœ… PASO 4: Â¡Listo!"
          echo "   Una vez emparejado, podrÃ¡s:"
          echo "   â€¢ Compilar proyectos iOS desde Visual Studio"
          echo "   â€¢ Usar el simulador de iOS remoto"
          echo "   â€¢ Depurar apps en dispositivos iOS conectados al Mac"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "      ğŸ“± SI EL SIMULADOR REMOTO NO CONECTA:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   El simulador remoto necesita una sesiÃ³n GUI activa."
          echo "   Sigue estos pasos:"
          echo ""
          echo "   1. Conecta VNC Viewer a localhost:5900"
          echo "      (ContraseÃ±a: Runner123)"
          echo ""
          echo "   2. En el escritorio del Mac (via VNC), abre Terminal y ejecuta:"
          echo "      open -a Simulator"
          echo ""
          echo "   3. Espera a que el simulador se abra completamente"
          echo ""
          echo "   4. Vuelve a Visual Studio e intenta conectar al simulador"
          echo ""
          echo "   ğŸ’¡ El simulador DEBE estar visible en el escritorio del Mac"
          echo "      para que el streaming remoto funcione"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "      âš ï¸ SI APARECE ERROR 'no user session' SIGUE ESTOS PASOS:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   1. Abre OTRA ventana de PowerShell"
          echo ""
          echo "   2. ConÃ©ctate por SSH:"
          echo "      ssh -p 2222 macuser@localhost"
          echo "      (ContraseÃ±a: Runner123)"
          echo ""
          echo "   3. Una vez dentro del Mac, ejecuta:"
          echo "      /tmp/login_macuser.sh"
          echo ""
          echo "   4. MANTÃ‰N ESA SESIÃ“N SSH ABIERTA"
          echo ""
          echo "   5. Ahora vuelve a Visual Studio y haz Retry en Pair to Mac"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "              CONEXIÃ“N VNC (ESCRITORIO REMOTO)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ–¥ï¸  PASO 1: Crear tÃºnel VNC (en otra ventana de PowerShell):"
            echo ""
            echo "   cloudflared access tcp --hostname $VNC_TUNNEL_HOST --url localhost:5900"
            echo ""
            echo "ğŸ–¥ï¸  PASO 2: Conectar con cliente VNC a: localhost:5900"
            echo "      ContraseÃ±a: Runner123"
            echo ""
            echo "   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "   â•‘  âš ï¸  IMPORTANTE: VNC muestra el escritorio de 'runner'     â•‘"
            echo "   â•‘  El usuario 'macuser' NO tiene escritorio GUI propio.      â•‘"
            echo "   â•‘                                                             â•‘"
            echo "   â•‘  Desde VNC puedes abrir Terminal y:                        â•‘"
            echo "   â•‘  - Cambiar a macuser: su - macuser (pass: Runner123)       â•‘"
            echo "   â•‘  - Abrir Simulator: open -a Simulator                      â•‘"
            echo "   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "              ALTERNATIVA: CONEXIÃ“N SSH DIRECTA"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   Si prefieres SSH directo desde PowerShell:"
          echo ""
          echo "   ssh -o ProxyCommand=\"cloudflared access tcp --hostname $SSH_TUNNEL_HOST\" runner@$SSH_TUNNEL_HOST"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Directorio del proyecto: $(pwd)"
          echo "ğŸ”§ Xcode version: $(xcodebuild -version | head -1)"
          echo "ğŸ”· .NET version: $(dotnet --version)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          MAC_PASSWORD: ${{ secrets.MAC_PASSWORD }}

      # ============================================
      # 11. Mantener sesiÃ³n activa
      # ============================================
      - name: â³ SesiÃ³n activa - Cancela el workflow para terminar
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   ğŸŸ¢ SESIÃ“N ACTIVA - Para terminar, cancela el workflow en GitHub"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Para cancelar: Ve a Actions > Este workflow > Cancel workflow"
          echo ""
          echo "âš ï¸  LÃ­mite mÃ¡ximo de GitHub Actions: 6 horas"
          echo ""
          
          # Mantener activo indefinidamente (hasta el timeout de GitHub o cancelaciÃ³n manual)
          while true; do
            echo "â±ï¸  $(date '+%Y-%m-%d %H:%M:%S') - SesiÃ³n activa..."
            
            # Verificar que los tÃºneles siguen activos
            if ! pgrep -f "cloudflared" > /dev/null; then
              echo "âš ï¸  TÃºnel desconectado, reiniciando..."
              nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
              sleep 5
            fi
            
            sleep 300  # Mostrar estado cada 5 minutos
          done

      # ============================================
      # 12. Limpieza
      # ============================================
      - name: ğŸ§¹ Limpieza
        if: always()
        run: |
          echo "Limpiando recursos..."
          pkill -f cloudflared || true
          sudo systemsetup -setremotelogin off || true
          echo "âœ… Limpieza completada"
