# ================================================================================
# GitHub Workflow: Pair to Mac - Conectar Visual Studio Windows con Mac remoto
# ================================================================================
# Este workflow crea un t√∫nel seguro para emparejar Visual Studio 2022/2026 
# con un Mac remoto de GitHub Actions para compilar apps iOS.
#
# ¬°¬° GRATIS - NO REQUIERE TARJETA DE CR√âDITO !!
# Usa Cloudflare Tunnel (cloudflared) que es completamente gratuito.
#
# INSTRUCCIONES:
# 1. Configura los secrets en GitHub (Settings > Secrets > Actions):
#    - MAC_PASSWORD: Contrase√±a para el usuario del Mac
#
# 2. Ejecuta este workflow manualmente desde Actions
#
# 3. Espera a que aparezca la URL del t√∫nel en los logs
#
# 4. En tu Windows local, instala cloudflared:
#    winget install Cloudflare.cloudflared
#    o descarga de: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
#
# 5. Configura el t√∫nel en tu m√°quina local (PowerShell):
#    cloudflared access tcp --hostname <URL_DEL_TUNEL> --url localhost:22
#
# 6. En Visual Studio: Tools > Options > Xamarin > iOS Settings
#    - Mac Host: localhost
#    - Port: 22
#    - Username: runner
#    - Password: (el que configuraste en MAC_PASSWORD)
#
# NOTA: El workflow dura m√°ximo 6 horas (l√≠mite de GitHub Actions)
# ================================================================================

name: üçé Pair to Mac (Visual Studio)

on:
  workflow_dispatch:
    inputs:
      tunnel_type:
        description: 'Tipo de t√∫nel'
        required: true
        default: 'ssh'
        type: choice
        options:
          - ssh
          - ssh_and_vnc

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true

jobs:
  pair-to-mac:
    name: üñ•Ô∏è Mac disponible para emparejar
    runs-on: macos-26
    timeout-minutes: 360  # M√°ximo 6 horas
    
    steps:
      # ============================================
      # 1. Checkout del c√≥digo (opcional, para tener el proyecto)
      # ============================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ============================================
      # 2. Mostrar informaci√≥n del sistema
      # ============================================
      - name: üìã Informaci√≥n del Sistema
        run: |
          echo "============================================"
          echo "   INFORMACI√ìN DEL MAC REMOTO"
          echo "============================================"
          echo ""
          echo "üñ•Ô∏è  macOS Version:"
          sw_vers
          echo ""
          echo "üíª Hardware:"
          system_profiler SPHardwareDataType | grep -E "Model|Processor|Memory|Cores"
          echo ""
          echo "üîß Xcode Version:"
          xcodebuild -version
          echo ""
          echo "üì± iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios
          echo ""
          echo "üî∑ .NET SDK:"
          dotnet --version
          echo ""
          echo "üë§ Usuario actual:"
          whoami
          echo ""
          echo "üè† Directorio home:"
          echo $HOME

      # ============================================
      # 3. Seleccionar Xcode 26.2
      # ============================================
      - name: üîß Configurar Xcode 26.2
        run: |
          # Buscar Xcode 26.2
          if [ -d "/Applications/Xcode_26.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
            echo "‚úÖ Xcode 26.2 seleccionado"
          elif [ -d "/Applications/Xcode_26.2.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.0.app/Contents/Developer
            echo "‚úÖ Xcode 26.2.0 seleccionado"
          else
            echo "‚ö†Ô∏è Usando Xcode por defecto"
          fi
          xcodebuild -version

      # ============================================
      # 4. Instalar .NET MAUI workloads
      # ============================================
      - name: üì¶ Instalar .NET MAUI Workloads
        run: |
          echo "Instalando workloads de MAUI..."
          dotnet workload install maui
          echo ""
          echo "‚úÖ Workloads instalados:"
          dotnet workload list

      # ============================================
      # 5. Configurar SSH para conexi√≥n remota
      # ============================================
      - name: üîê Configurar SSH y Acceso Remoto
        id: ssh_config
        run: |
          echo "Configurando SSH..."
          
          # Contrase√±a fija para facilitar la conexi√≥n
          PASSWORD="Runner123"
          
          # Crear un nuevo usuario para SSH (m√°s confiable que modificar runner)
          if ! id "macuser" &>/dev/null; then
            echo "Creando usuario 'macuser' para SSH..."
            sudo sysadminctl -addUser macuser -password "$PASSWORD" -admin
          else
            echo "Usuario macuser ya existe"
          fi
          
          # Dar permisos de administrador al usuario
          sudo dseditgroup -o edit -a macuser -t user admin
          sudo dseditgroup -o edit -a macuser -t user wheel
          
          # Habilitar login remoto (SSH)
          sudo systemsetup -setremotelogin on
          
          # Configurar SSH para permitir autenticaci√≥n por contrase√±a
          sudo sed -i '' 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^KbdInteractiveAuthentication no/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#UsePAM.*/UsePAM yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^UsePAM no/UsePAM yes/' /etc/ssh/sshd_config
          
          # Agregar configuraciones expl√≠citas
          cat << 'EOF' | sudo tee -a /etc/ssh/sshd_config
          
          # Configuraci√≥n para Pair to Mac
          PasswordAuthentication yes
          KbdInteractiveAuthentication yes
          UsePAM yes
          PermitRootLogin no
          EOF
          
          # Reiniciar servicio SSH
          sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
          
          # Verificar que SSH est√° funcionando
          sleep 2
          if sudo lsof -i :22 | grep -q LISTEN; then
            echo "‚úÖ SSH est√° escuchando en puerto 22"
          else
            echo "‚ö†Ô∏è Intentando iniciar SSH de otra manera..."
            sudo launchctl start com.openssh.sshd || true
          fi
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  CREDENCIALES DE ACCESO"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üë§ Usuario:     macuser"
          echo "  üîë Contrase√±a:  $PASSWORD"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          
          # Guardar para usar despu√©s
          echo "MAC_USER=macuser" >> $GITHUB_ENV
          echo "MAC_PASS=$PASSWORD" >> $GITHUB_ENV

      # ============================================
      # 5.1 Crear sesi√≥n de usuario (requerido para Pair to Mac)
      # ============================================
      - name: üë§ Crear Sesi√≥n de Usuario para Pair to Mac
        run: |
          echo "Creando sesi√≥n de usuario para Visual Studio Pair to Mac..."
          
          PASSWORD="Runner123"
          
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          # IMPORTANTE: El usuario 'runner' YA tiene sesi√≥n activa
          # Configuramos TAMBI√âN al usuario runner para Pair to Mac
          # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          # Configurar contrase√±a para el usuario 'runner' (ya tiene sesi√≥n)
          echo "Configurando usuario 'runner' (tiene sesi√≥n GUI activa)..."
          echo "$PASSWORD" | sudo -S dscl . -passwd /Users/runner "$PASSWORD" 2>/dev/null || {
            # Si falla, intentar con otro m√©todo
            sudo security set-keychain-password -o "" -p "$PASSWORD" /Users/runner/Library/Keychains/login.keychain-db 2>/dev/null || true
          }
          
          # Obtener el UID del usuario macuser
          MACUSER_UID=$(id -u macuser)
          echo "UID de macuser: $MACUSER_UID"
          
          # M√©todo 1: Configurar auto-login (simula sesi√≥n activa)
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser macuser 2>/dev/null || true
          
          # M√©todo 2: Iniciar un agente de usuario para macuser
          sudo launchctl bootstrap gui/$MACUSER_UID 2>/dev/null || true
          
          # M√©todo 3: Crear el directorio de sesi√≥n del usuario
          sudo mkdir -p /Users/macuser/Library/LaunchAgents
          sudo chown -R macuser:staff /Users/macuser
          
          # M√©todo 4: Iniciar loginwindow para el usuario (crea sesi√≥n GUI)
          sudo launchctl asuser $MACUSER_UID /System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow 2>/dev/null &
          sleep 2
          
          # M√©todo 5: Habilitar escritorio remoto / acceso GUI
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -users macuser,runner \
            -privs -all \
            -restart -agent 2>/dev/null || true
          
          # M√©todo 6: Iniciar WindowServer connection para el usuario
          sudo launchctl asuser $MACUSER_UID launchctl start com.apple.WindowServer 2>/dev/null || true
          
          # M√©todo 7: Crear un launchd plist para mantener sesi√≥n activa
          cat << 'PLIST' | sudo tee /Library/LaunchDaemons/com.github.pairsession.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>com.github.pairsession</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/bin/bash</string>
                  <string>-c</string>
                  <string>launchctl asuser $(id -u macuser) true</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
          </dict>
          </plist>
          PLIST
          sudo launchctl load /Library/LaunchDaemons/com.github.pairsession.plist 2>/dev/null || true
          
          # Verificar sesiones activas
          echo ""
          echo "Sesiones activas:"
          who -a 2>/dev/null || true
          
          echo ""
          echo "Usuarios disponibles:"
          echo "  - runner (sesi√≥n GUI activa por defecto)"
          echo "  - macuser (sesi√≥n creada)"
          
          echo ""
          echo "‚úÖ Sesi√≥n de usuario configurada"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üí° TIP: Si 'macuser' no funciona, intenta con 'runner'"
          echo "     Usuario: runner"
          echo "     Contrase√±a: $PASSWORD"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      # ============================================
      # 6. Configurar VNC (si se selecciona)
      # ============================================
      - name: üñ•Ô∏è Configurar VNC/Screen Sharing
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        env:
          MAC_PASSWORD: ${{ secrets.MAC_PASSWORD }}
        run: |
          echo "Configurando VNC/Screen Sharing..."
          
          PASSWORD="${MAC_PASSWORD:-Runner123!}"
          
          # Configurar contrase√±a VNC
          sudo /usr/bin/dscl . -passwd /Users/runner "$PASSWORD"
          
          # Habilitar Screen Sharing (VNC)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$PASSWORD" \
            -restart -agent -privs -all
          
          echo "‚úÖ VNC/Screen Sharing habilitado"
          echo "üñ•Ô∏è Puerto VNC: 5900"

      # ============================================
      # 7. Instalar Cloudflare Tunnel
      # ============================================
      - name: ‚òÅÔ∏è Instalar Cloudflare Tunnel
        run: |
          echo "Instalando cloudflared..."
          brew install cloudflare/cloudflare/cloudflared
          cloudflared --version
          echo "‚úÖ Cloudflared instalado"

      # ============================================
      # 8. Iniciar t√∫nel SSH
      # ============================================
      - name: üöá Iniciar T√∫nel SSH
        id: ssh_tunnel
        run: |
          echo "Iniciando t√∫nel SSH con Cloudflare..."
          
          # Iniciar t√∫nel en background
          nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
          SSH_TUNNEL_PID=$!
          echo "SSH_TUNNEL_PID=$SSH_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el t√∫nel est√© listo
          echo "Esperando a que el t√∫nel est√© listo..."
          sleep 15
          
          # Obtener URL del t√∫nel
          SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "")
          
          if [ -z "$SSH_TUNNEL_URL" ]; then
            echo "Reintentando obtener URL..."
            sleep 10
            SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "URL_NO_DISPONIBLE")
          fi
          
          # Convertir a hostname sin https://
          SSH_TUNNEL_HOST=$(echo "$SSH_TUNNEL_URL" | sed 's|https://||')
          
          echo "SSH_TUNNEL_URL=$SSH_TUNNEL_URL" >> $GITHUB_ENV
          echo "SSH_TUNNEL_HOST=$SSH_TUNNEL_HOST" >> $GITHUB_ENV
          echo "ssh_url=$SSH_TUNNEL_HOST" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úÖ T√∫nel SSH iniciado"
          echo "üîó URL: $SSH_TUNNEL_URL"

      # ============================================
      # 9. Iniciar t√∫nel VNC (si se selecciona)
      # ============================================
      - name: üöá Iniciar T√∫nel VNC
        id: vnc_tunnel
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Iniciando t√∫nel VNC con Cloudflare..."
          
          # Iniciar t√∫nel en background
          nohup cloudflared tunnel --url tcp://localhost:5900 --logfile /tmp/vnc_tunnel.log 2>&1 &
          VNC_TUNNEL_PID=$!
          echo "VNC_TUNNEL_PID=$VNC_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el t√∫nel est√© listo
          sleep 15
          
          # Obtener URL del t√∫nel
          VNC_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/vnc_tunnel.log || echo "URL_NO_DISPONIBLE")
          VNC_TUNNEL_HOST=$(echo "$VNC_TUNNEL_URL" | sed 's|https://||')
          
          echo "VNC_TUNNEL_URL=$VNC_TUNNEL_URL" >> $GITHUB_ENV
          echo "VNC_TUNNEL_HOST=$VNC_TUNNEL_HOST" >> $GITHUB_ENV
          
          echo ""
          echo "‚úÖ T√∫nel VNC iniciado"
          echo "üîó URL: $VNC_TUNNEL_URL"

      # ============================================
      # 10. Mostrar instrucciones de conexi√≥n
      # ============================================
      - name: üìã Instrucciones de Conexi√≥n
        run: |
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë                                                                    ‚ïë"
          echo "‚ïë   üçé MAC REMOTO LISTO PARA EMPAREJAR CON VISUAL STUDIO üçé        ‚ïë"
          echo "‚ïë                                                                    ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "                    INFORMACI√ìN DE CONEXI√ìN"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üîó T√∫nel SSH:     $SSH_TUNNEL_URL"
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  USUARIOS DISPONIBLES (prueba en este orden):                   ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë  üë§ Opci√≥n 1 (RECOMENDADO - tiene sesi√≥n activa):              ‚ïë"
          echo "‚ïë     Usuario:    runner                                          ‚ïë"
          echo "‚ïë     Contrase√±a: Runner123                                       ‚ïë"
          echo "‚ïë                                                                  ‚ïë"
          echo "‚ïë  üë§ Opci√≥n 2 (alternativa):                                     ‚ïë"
          echo "‚ïë     Usuario:    macuser                                         ‚ïë"
          echo "‚ïë     Contrase√±a: Runner123                                       ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "‚è±Ô∏è  Duraci√≥n:      Hasta que canceles el workflow manualmente"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "üñ•Ô∏è  T√∫nel VNC:     $VNC_TUNNEL_URL"
            echo ""
          fi
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "           PASOS PARA CONECTAR DESDE WINDOWS"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üì• PASO 1: Instalar cloudflared en tu Windows"
          echo "   Abre PowerShell como Administrador y ejecuta:"
          echo ""
          echo "   winget install Cloudflare.cloudflared"
          echo ""
          echo "   O descarga manualmente de:"
          echo "   https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo ""
          echo "üîå PASO 2: Crear t√∫nel local (PowerShell)"
          echo "   Ejecuta este comando para crear el t√∫nel:"
          echo ""
          echo "   cloudflared access tcp --hostname $SSH_TUNNEL_HOST --url localhost:2222"
          echo ""
          echo "   ‚ö†Ô∏è  Mant√©n esta ventana abierta mientras uses el Mac"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo ""
          echo "üîß PASO 3: Configurar Visual Studio"
          echo ""
          echo "   A) Ve a: Tools > Options > Xamarin > iOS Settings"
          echo ""
          echo "   B) En 'Pair to Mac', configura:"
          echo "      ‚Ä¢ Host:     localhost"
          echo "      ‚Ä¢ Port:     2222"
          echo ""
          echo "   C) Haz clic en 'Pair' e ingresa:"
          echo "      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
          echo "      ‚îÇ  üëâ PRUEBA PRIMERO CON:                     ‚îÇ"
          echo "      ‚îÇ     Username: runner                        ‚îÇ"
          echo "      ‚îÇ     Password: Runner123                     ‚îÇ"
          echo "      ‚îÇ                                             ‚îÇ"
          echo "      ‚îÇ  Si no funciona, intenta con:               ‚îÇ"
          echo "      ‚îÇ     Username: macuser                       ‚îÇ"
          echo "      ‚îÇ     Password: Runner123                     ‚îÇ"
          echo "      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
          echo ""
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo ""
          echo "‚úÖ PASO 4: ¬°Listo!"
          echo "   Una vez emparejado, podr√°s:"
          echo "   ‚Ä¢ Compilar proyectos iOS desde Visual Studio"
          echo "   ‚Ä¢ Usar el simulador de iOS remoto"
          echo "   ‚Ä¢ Depurar apps en dispositivos iOS conectados al Mac"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "              CONEXI√ìN VNC (ESCRITORIO REMOTO)"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üñ•Ô∏è  PASO 1: Crear t√∫nel VNC (en otra ventana de PowerShell):"
            echo ""
            echo "   cloudflared access tcp --hostname $VNC_TUNNEL_HOST --url localhost:5900"
            echo ""
            echo "üñ•Ô∏è  PASO 2: Conectar con cliente VNC a: localhost:5900"
            echo ""
          fi
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "              ALTERNATIVA: CONEXI√ìN SSH DIRECTA"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "   Si prefieres SSH directo desde PowerShell:"
          echo ""
          echo "   ssh -o ProxyCommand=\"cloudflared access tcp --hostname $SSH_TUNNEL_HOST\" runner@$SSH_TUNNEL_HOST"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìÅ Directorio del proyecto: $(pwd)"
          echo "üîß Xcode version: $(xcodebuild -version | head -1)"
          echo "üî∑ .NET version: $(dotnet --version)"
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        env:
          MAC_PASSWORD: ${{ secrets.MAC_PASSWORD }}

      # ============================================
      # 11. Mantener sesi√≥n activa
      # ============================================
      - name: ‚è≥ Sesi√≥n activa - Cancela el workflow para terminar
        run: |
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "   üü¢ SESI√ìN ACTIVA - Para terminar, cancela el workflow en GitHub"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìã Para cancelar: Ve a Actions > Este workflow > Cancel workflow"
          echo ""
          echo "‚ö†Ô∏è  L√≠mite m√°ximo de GitHub Actions: 6 horas"
          echo ""
          
          # Mantener activo indefinidamente (hasta el timeout de GitHub o cancelaci√≥n manual)
          while true; do
            echo "‚è±Ô∏è  $(date '+%Y-%m-%d %H:%M:%S') - Sesi√≥n activa..."
            
            # Verificar que los t√∫neles siguen activos
            if ! pgrep -f "cloudflared" > /dev/null; then
              echo "‚ö†Ô∏è  T√∫nel desconectado, reiniciando..."
              nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
              sleep 5
            fi
            
            sleep 300  # Mostrar estado cada 5 minutos
          done

      # ============================================
      # 12. Limpieza
      # ============================================
      - name: üßπ Limpieza
        if: always()
        run: |
          echo "Limpiando recursos..."
          pkill -f cloudflared || true
          sudo systemsetup -setremotelogin off || true
          echo "‚úÖ Limpieza completada"
