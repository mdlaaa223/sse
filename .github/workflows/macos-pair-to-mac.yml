# ================================================================================
# GitHub Workflow: Pair to Mac - Conectar Visual Studio Windows con Mac remoto
# ================================================================================
# Este workflow crea un tÃºnel seguro para emparejar Visual Studio 2022/2026 
# con un Mac remoto de GitHub Actions para compilar apps iOS.
#
# Â¡Â¡ GRATIS - NO REQUIERE TARJETA DE CRÃ‰DITO !!
# Usa Cloudflare Tunnel (cloudflared) que es completamente gratuito.
#
# INSTRUCCIONES:
# 1. Configura los secrets en GitHub (Settings > Secrets > Actions):
#    - MAC_PASSWORD: ContraseÃ±a para el usuario del Mac
#
# 2. Ejecuta este workflow manualmente desde Actions
#
# 3. Espera a que aparezca la URL del tÃºnel en los logs
#
# 4. En tu Windows local, instala cloudflared:
#    winget install Cloudflare.cloudflared
#    o descarga de: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
#
# 5. Configura el tÃºnel en tu mÃ¡quina local (PowerShell):
#    cloudflared access tcp --hostname <URL_DEL_TUNEL> --url localhost:22
#
# 6. En Visual Studio: Tools > Options > Xamarin > iOS Settings
#    - Mac Host: localhost
#    - Port: 22
#    - Username: runner
#    - Password: (el que configuraste en MAC_PASSWORD)
#
# NOTA: El workflow dura mÃ¡ximo 6 horas (lÃ­mite de GitHub Actions)
# ================================================================================

name: ğŸ Pair to Mac (Visual Studio)

on:
  workflow_dispatch:
    inputs:
      tunnel_type:
        description: 'Tipo de tÃºnel (VNC recomendado para crear sesiÃ³n GUI)'
        required: true
        default: 'ssh_and_vnc'
        type: choice
        options:
          - ssh_and_vnc
          - ssh

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true

jobs:
  pair-to-mac:
    name: ğŸ–¥ï¸ Mac disponible para emparejar
    runs-on: macos-26
    timeout-minutes: 360  # MÃ¡ximo 6 horas
    
    steps:
      # ============================================
      # 1. Checkout del cÃ³digo (opcional, para tener el proyecto)
      # ============================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ============================================
      # 2. Mostrar informaciÃ³n del sistema
      # ============================================
      - name: ğŸ“‹ InformaciÃ³n del Sistema
        run: |
          echo "============================================"
          echo "   INFORMACIÃ“N DEL MAC REMOTO"
          echo "============================================"
          echo ""
          echo "ğŸ–¥ï¸  macOS Version:"
          sw_vers
          echo ""
          echo "ğŸ’» Hardware:"
          system_profiler SPHardwareDataType | grep -E "Model|Processor|Memory|Cores"
          echo ""
          echo "ğŸ”§ Xcode Version:"
          xcodebuild -version
          echo ""
          echo "ğŸ“± iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios
          echo ""
          echo "ğŸ”· .NET SDK:"
          dotnet --version
          echo ""
          echo "ğŸ‘¤ Usuario actual:"
          whoami
          echo ""
          echo "ğŸ  Directorio home:"
          echo $HOME

      # ============================================
      # 3. Seleccionar Xcode 26.2 (tiene simuladores)
      # ============================================
      - name: ğŸ”§ Configurar Xcode 26.2
        run: |
          echo "Buscando versiones de Xcode disponibles..."
          ls -la /Applications/ | grep Xcode
          
          # Usar Xcode 26.2 porque tiene los simuladores
          if [ -d "/Applications/Xcode_26.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
            echo "âœ… Xcode 26.2 seleccionado"
          elif [ -d "/Applications/Xcode_26.2.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.0.app/Contents/Developer
            echo "âœ… Xcode 26.2.0 seleccionado"
          else
            echo "âš ï¸ Usando Xcode por defecto"
          fi
          
          echo ""
          echo "Xcode seleccionado:"
          xcodebuild -version
          echo ""
          echo "iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios
          echo ""
          echo "Simuladores disponibles:"
          xcrun simctl list devices available | head -20

      # ============================================
      # 4. Instalar .NET MAUI workloads (compatible con Xcode 26.2)
      # ============================================
      - name: ğŸ“¦ Instalar .NET MAUI Workloads
        run: |
          echo "Instalando workloads de MAUI con soporte para Xcode 26.2..."
          
          # Primero, limpiar workloads anteriores que puedan causar conflictos
          dotnet workload repair || true
          
          # Instalar workloads de MAUI
          dotnet workload install maui --skip-manifest-update
          
          # Instalar especÃ­ficamente el workload de iOS mÃ¡s reciente
          # que soporte Xcode 26.2
          echo ""
          echo "Instalando SDK de iOS compatible con Xcode 26.2..."
          dotnet workload install ios --skip-manifest-update || true
          dotnet workload install maccatalyst --skip-manifest-update || true
          
          # Verificar versiones instaladas
          echo ""
          echo "âœ… Workloads instalados:"
          dotnet workload list
          
          # Mostrar informaciÃ³n del SDK de iOS
          echo ""
          echo "Versiones de SDK disponibles:"
          ls -la /usr/local/share/dotnet/packs/ | grep -i ios || true
          ls -la ~/.dotnet/packs/ | grep -i ios || true

      # ============================================
      # 5. Configurar SSH para conexiÃ³n remota
      # ============================================
      - name: ğŸ” Configurar SSH y Acceso Remoto
        id: ssh_config
        run: |
          echo "Configurando SSH..."
          
          # ContraseÃ±a fija para facilitar la conexiÃ³n
          PASSWORD="Runner123"
          
          # Crear un nuevo usuario para SSH (mÃ¡s confiable que modificar runner)
          if ! id "macuser" &>/dev/null; then
            echo "Creando usuario 'macuser' para SSH..."
            sudo sysadminctl -addUser macuser -password "$PASSWORD" -admin
          else
            echo "Usuario macuser ya existe"
          fi
          
          # Dar permisos de administrador al usuario
          sudo dseditgroup -o edit -a macuser -t user admin
          sudo dseditgroup -o edit -a macuser -t user wheel
          
          # Habilitar login remoto (SSH)
          sudo systemsetup -setremotelogin on
          
          # Configurar SSH para permitir autenticaciÃ³n por contraseÃ±a
          sudo sed -i '' 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^KbdInteractiveAuthentication no/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#UsePAM.*/UsePAM yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^UsePAM no/UsePAM yes/' /etc/ssh/sshd_config
          
          # Agregar configuraciones explÃ­citas
          cat << 'EOF' | sudo tee -a /etc/ssh/sshd_config
          
          # ConfiguraciÃ³n para Pair to Mac
          PasswordAuthentication yes
          KbdInteractiveAuthentication yes
          UsePAM yes
          PermitRootLogin no
          EOF
          
          # Reiniciar servicio SSH
          sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
          
          # Verificar que SSH estÃ¡ funcionando
          sleep 2
          if sudo lsof -i :22 | grep -q LISTEN; then
            echo "âœ… SSH estÃ¡ escuchando en puerto 22"
          else
            echo "âš ï¸ Intentando iniciar SSH de otra manera..."
            sudo launchctl start com.openssh.sshd || true
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  CREDENCIALES DE ACCESO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ‘¤ Usuario:     macuser"
          echo "  ğŸ”‘ ContraseÃ±a:  $PASSWORD"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Guardar para usar despuÃ©s
          echo "MAC_USER=macuser" >> $GITHUB_ENV
          echo "MAC_PASS=$PASSWORD" >> $GITHUB_ENV

      # ============================================
      # 5.1 Crear sesiÃ³n de usuario (requerido para Pair to Mac)
      # ============================================
      - name: ğŸ‘¤ Crear SesiÃ³n de Usuario para Pair to Mac
        run: |
          echo "Creando sesiÃ³n de usuario para Visual Studio Pair to Mac..."
          
          PASSWORD="Runner123"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 1: Configurar contraseÃ±a para 'runner' usando sysadminctl
          # El usuario 'runner' YA tiene sesiÃ³n GUI activa en GitHub Actions
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Intentando configurar contraseÃ±a para 'runner'..."
          
          # MÃ©todo A: Usar sysadminctl para crear/resetear contraseÃ±a
          # En macOS, podemos usar -adminUser con el usuario actual si tiene permisos
          sudo sysadminctl -resetPasswordFor runner -newPassword "$PASSWORD" -passwordHint "pair" 2>/dev/null || {
            echo "MÃ©todo A fallÃ³, intentando mÃ©todo B..."
            
            # MÃ©todo B: Usar dscl con SecureToken
            sudo dscl . -passwd /Users/runner "" "$PASSWORD" 2>/dev/null || {
              echo "MÃ©todo B fallÃ³, intentando mÃ©todo C..."
              
              # MÃ©todo C: Crear entrada de contraseÃ±a directamente
              sudo security set-keychain-password -o "" -p "$PASSWORD" /Users/runner/Library/Keychains/login.keychain-db 2>/dev/null || true
            }
          }
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 2: Crear sesiÃ³n GUI real para 'macuser'
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Configurando sesiÃ³n GUI para 'macuser'..."
          
          MACUSER_UID=$(id -u macuser)
          RUNNER_UID=$(id -u runner)
          echo "UID de macuser: $MACUSER_UID"
          echo "UID de runner: $RUNNER_UID"
          
          # Crear el directorio home completo para macuser
          sudo mkdir -p /Users/macuser/Library/Preferences
          sudo mkdir -p /Users/macuser/Library/LaunchAgents
          sudo mkdir -p /Users/macuser/Library/Caches
          sudo chown -R macuser:staff /Users/macuser
          
          # Copiar configuraciones bÃ¡sicas desde runner
          sudo cp -R /Users/runner/Library/Preferences/* /Users/macuser/Library/Preferences/ 2>/dev/null || true
          sudo chown -R macuser:staff /Users/macuser/Library/Preferences
          
          # Habilitar auto-login para macuser (esto ayuda a crear la sesiÃ³n)
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser macuser
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUserUID $MACUSER_UID
          
          # Crear el bootstrap GUI para macuser
          sudo launchctl bootstrap gui/$MACUSER_UID /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
          sudo launchctl asuser $MACUSER_UID launchctl load -S Aqua /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
          
          # Iniciar una sesiÃ³n de login para macuser
          # Esto simula un login grÃ¡fico
          sudo /System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow console $MACUSER_UID 2>/dev/null &
          sleep 3
          
          # Configurar Remote Management para ambos usuarios
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -users macuser,runner \
            -privs -all \
            -restart -agent 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 3: Iniciar el Broker de XMA (Xamarin Mac Agent)
          # Este es el servicio que Visual Studio busca
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Preparando Xamarin Mac Agent para ambos usuarios..."
          
          # El XMA Broker necesita correr como el usuario conectado
          # Creamos un script que lo inicia para macuser
          
          cat << 'SCRIPT' | sudo tee /tmp/start_xma_session.sh
          #!/bin/bash
          # Iniciar sesiÃ³n de usuario para XMA
          export HOME=/Users/macuser
          export USER=macuser
          export LOGNAME=macuser
          
          # Crear el archivo de sesiÃ³n que XMA busca
          mkdir -p /Users/macuser/Library/Application\ Support/Xamarin
          touch /Users/macuser/Library/Application\ Support/Xamarin/.session
          
          # Mantener la sesiÃ³n activa
          while true; do
            sleep 60
          done
          SCRIPT
          
          sudo chmod +x /tmp/start_xma_session.sh
          sudo -u macuser /tmp/start_xma_session.sh &
          
          # TambiÃ©n para runner
          mkdir -p "/Users/runner/Library/Application Support/Xamarin" 2>/dev/null || true
          touch "/Users/runner/Library/Application Support/Xamarin/.session" 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 4: Forzar creaciÃ³n de sesiÃ³n GUI usando launchd
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Crear un LaunchAgent que mantiene viva la sesiÃ³n
          cat << 'PLIST' | sudo tee /Library/LaunchDaemons/com.github.usersession.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>com.github.usersession</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/bin/bash</string>
                  <string>-c</string>
                  <string>launchctl asuser 502 /bin/bash -c "export HOME=/Users/macuser; while true; do sleep 60; done"</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              <key>UserName</key>
              <string>root</string>
          </dict>
          </plist>
          PLIST
          
          sudo launchctl load /Library/LaunchDaemons/com.github.usersession.plist 2>/dev/null || true
          
          # Verificar sesiones
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Sesiones activas despuÃ©s de configuraciÃ³n:"
          who -a 2>/dev/null || true
          echo ""
          echo "Procesos de loginwindow:"
          ps aux | grep -i loginwindow | grep -v grep || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo ""
          echo "âœ… ConfiguraciÃ³n de sesiÃ³n completada"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  IMPORTANTE: Si 'macuser' sigue sin funcionar, usa 'runner'    â•‘"
          echo "â•‘  pero deberÃ¡s probar si la contraseÃ±a se configurÃ³ bien.       â•‘"
          echo "â•‘                                                                 â•‘"
          echo "â•‘  Usuario: macuser  |  ContraseÃ±a: Runner123                    â•‘"
          echo "â•‘  Usuario: runner   |  ContraseÃ±a: Runner123 (si funcionÃ³)      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 6. Configurar VNC (IMPORTANTE: Crea la sesiÃ³n GUI para Pair to Mac)
      # ============================================
      - name: ğŸ–¥ï¸ Configurar VNC/Screen Sharing (CREA SESIÃ“N GUI)
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  CONFIGURANDO VNC - ESTO CREA LA SESIÃ“N GUI PARA PAIR TO MAC    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          PASSWORD="Runner123"
          
          # Detener cualquier proceso ARD existente
          sudo killall ARDAgent 2>/dev/null || true
          sleep 2
          
          # Configurar VNC para macuser Y runner
          echo "Configurando VNC para usuarios macuser y runner..."
          
          # Habilitar Screen Sharing (VNC) con configuraciÃ³n completa
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -configure -allowAccessFor -allUsers \
            -configure -users macuser,runner \
            -configure -restart -agent \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$PASSWORD" \
            -privs -all
          
          # Configurar Screen Sharing directamente
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Habilitar login grÃ¡fico automÃ¡tico para macuser
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser macuser
          
          # Configurar que VNC acepte conexiones sin autenticaciÃ³n adicional despuÃ©s del password
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true 2>/dev/null || true
          
          # Reiniciar el agente ARD
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          # Verificar que VNC estÃ¡ escuchando
          sleep 3
          if sudo lsof -i :5900 | grep -q LISTEN; then
            echo "âœ… VNC estÃ¡ escuchando en puerto 5900"
          else
            echo "âš ï¸ Intentando iniciar VNC nuevamente..."
            sudo launchctl start com.apple.screensharing || true
            sleep 2
          fi
          
          echo ""
          echo "âœ… VNC/Screen Sharing habilitado"
          echo "ğŸ–¥ï¸ Puerto VNC: 5900"
          echo "ğŸ”‘ ContraseÃ±a VNC: $PASSWORD"

      # ============================================
      # 6.1 Crear script de sesiÃ³n para macuser
      # ============================================
      - name: ğŸ“ Crear Script de SesiÃ³n para macuser
        run: |
          PASSWORD="Runner123"
          
          # Crear script para login de macuser (sin pedir contraseÃ±a)
          cat << 'LOGINSCRIPT' | sudo tee /tmp/login_macuser.sh
          #!/bin/bash
          # Script para iniciar sesiÃ³n como macuser SIN PEDIR CONTRASEÃ‘A
          echo "==================================="
          echo "Iniciando sesiÃ³n como macuser..."
          echo "==================================="
          
          # Usar sudo para cambiar a macuser sin contraseÃ±a
          sudo -u macuser bash -c '
            export HOME=/Users/macuser
            export USER=macuser
            cd ~
            
            # Crear marcador de sesiÃ³n para XMA (Xamarin Mac Agent)
            mkdir -p ~/Library/Application\ Support/Xamarin
            touch ~/Library/Application\ Support/Xamarin/.session
            
            # Crear otros directorios que XMA puede necesitar
            mkdir -p ~/Library/Caches/Xamarin
            mkdir -p ~/Library/Logs/Xamarin
            
            echo "âœ… SesiÃ³n de macuser iniciada"
            echo "ğŸ“ Directorio: $(pwd)"
            echo "ğŸ‘¤ Usuario: $(whoami)"
            echo ""
            echo "Esta sesiÃ³n se mantendrÃ¡ activa."
            echo "NO CIERRES ESTA VENTANA mientras uses Pair to Mac."
            echo ""
            
            # Mantener sesiÃ³n activa indefinidamente
            while true; do
              sleep 30
              echo "â±ï¸ $(date) - SesiÃ³n activa..."
            done
          '
          LOGINSCRIPT
          sudo chmod +x /tmp/login_macuser.sh
          
          # TambiÃ©n crear directorios de Xamarin para runner
          mkdir -p ~/Library/Application\ Support/Xamarin
          touch ~/Library/Application\ Support/Xamarin/.session
          mkdir -p ~/Library/Caches/Xamarin
          mkdir -p ~/Library/Logs/Xamarin
          
          # Y para macuser directamente
          sudo -u macuser mkdir -p /Users/macuser/Library/Application\ Support/Xamarin
          sudo -u macuser touch /Users/macuser/Library/Application\ Support/Xamarin/.session
          sudo -u macuser mkdir -p /Users/macuser/Library/Caches/Xamarin
          sudo -u macuser mkdir -p /Users/macuser/Library/Logs/Xamarin
          
          echo "âœ… Script de sesiÃ³n creado: /tmp/login_macuser.sh"

      # ============================================
      # 7. Instalar Cloudflare Tunnel
      # ============================================
      - name: â˜ï¸ Instalar Cloudflare Tunnel
        run: |
          echo "Instalando cloudflared..."
          brew install cloudflare/cloudflare/cloudflared
          cloudflared --version
          echo "âœ… Cloudflared instalado"

      # ============================================
      # 8. Iniciar tÃºnel SSH
      # ============================================
      - name: ğŸš‡ Iniciar TÃºnel SSH
        id: ssh_tunnel
        run: |
          echo "Iniciando tÃºnel SSH con Cloudflare..."
          
          # Iniciar tÃºnel en background
          nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
          SSH_TUNNEL_PID=$!
          echo "SSH_TUNNEL_PID=$SSH_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el tÃºnel estÃ© listo
          echo "Esperando a que el tÃºnel estÃ© listo..."
          sleep 15
          
          # Obtener URL del tÃºnel
          SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "")
          
          if [ -z "$SSH_TUNNEL_URL" ]; then
            echo "Reintentando obtener URL..."
            sleep 10
            SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "URL_NO_DISPONIBLE")
          fi
          
          # Convertir a hostname sin https://
          SSH_TUNNEL_HOST=$(echo "$SSH_TUNNEL_URL" | sed 's|https://||')
          
          echo "SSH_TUNNEL_URL=$SSH_TUNNEL_URL" >> $GITHUB_ENV
          echo "SSH_TUNNEL_HOST=$SSH_TUNNEL_HOST" >> $GITHUB_ENV
          echo "ssh_url=$SSH_TUNNEL_HOST" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… TÃºnel SSH iniciado"
          echo "ğŸ”— URL: $SSH_TUNNEL_URL"

      # ============================================
      # 9. Iniciar tÃºnel VNC (si se selecciona)
      # ============================================
      - name: ğŸš‡ Iniciar TÃºnel VNC
        id: vnc_tunnel
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Iniciando tÃºnel VNC con Cloudflare..."
          
          # Iniciar tÃºnel en background
          nohup cloudflared tunnel --url tcp://localhost:5900 --logfile /tmp/vnc_tunnel.log 2>&1 &
          VNC_TUNNEL_PID=$!
          echo "VNC_TUNNEL_PID=$VNC_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el tÃºnel estÃ© listo
          sleep 15
          
          # Obtener URL del tÃºnel
          VNC_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/vnc_tunnel.log || echo "URL_NO_DISPONIBLE")
          VNC_TUNNEL_HOST=$(echo "$VNC_TUNNEL_URL" | sed 's|https://||')
          
          echo "VNC_TUNNEL_URL=$VNC_TUNNEL_URL" >> $GITHUB_ENV
          echo "VNC_TUNNEL_HOST=$VNC_TUNNEL_HOST" >> $GITHUB_ENV
          
          echo ""
          echo "âœ… TÃºnel VNC iniciado"
          echo "ğŸ”— URL: $VNC_TUNNEL_URL"

      # ============================================
      # 10. Mostrar instrucciones de conexiÃ³n
      # ============================================
      - name: ğŸ“‹ Instrucciones de ConexiÃ³n
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ MAC REMOTO LISTO PARA EMPAREJAR CON VISUAL STUDIO ğŸ        â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    INFORMACIÃ“N DE CONEXIÃ“N"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”— TÃºnel SSH:     $SSH_TUNNEL_URL"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  USUARIOS DISPONIBLES (prueba en este orden):                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ‘¤ OpciÃ³n 1 (RECOMENDADO - tiene sesiÃ³n activa):              â•‘"
          echo "â•‘     Usuario:    runner                                          â•‘"
          echo "â•‘     ContraseÃ±a: Runner123                                       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ‘¤ OpciÃ³n 2 (alternativa):                                     â•‘"
          echo "â•‘     Usuario:    macuser                                         â•‘"
          echo "â•‘     ContraseÃ±a: Runner123                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â±ï¸  DuraciÃ³n:      Hasta que canceles el workflow manualmente"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "ğŸ–¥ï¸  TÃºnel VNC:     $VNC_TUNNEL_URL"
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           PASOS PARA CONECTAR DESDE WINDOWS"
          echo "           â­ FLUJO PROBADO QUE FUNCIONA â­"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¥ REQUISITOS: Instalar en Windows"
          echo ""
          echo "   winget install Cloudflare.cloudflared"
          echo "   VNC Viewer: https://www.realvnc.com/en/connect/download/viewer/"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           ğŸ”„ FLUJO QUE FUNCIONA (seguir en orden)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ PASO 1: Iniciar tÃºnel SSH (PowerShell #1)"
          echo ""
          echo "   cloudflared access tcp --hostname $SSH_TUNNEL_HOST --url localhost:2222"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "ğŸ“‹ PASO 2: Conectar SSH y ejecutar script (PowerShell #2)"
          echo ""
          echo "   ssh -p 2222 macuser@localhost"
          echo "   ContraseÃ±a: Runner123"
          echo ""
          echo "   Dentro del Mac ejecutar:"
          echo "   /tmp/login_macuser.sh"
          echo ""
          echo "   âš ï¸ MantÃ©n esta ventana abierta (no importa si se cierra despuÃ©s)"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "ğŸ“‹ PASO 3: Iniciar tÃºnel VNC (PowerShell #3)"
            echo ""
            echo "   cloudflared access tcp --hostname $VNC_TUNNEL_HOST --url localhost:5900"
            echo ""
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo ""
            echo "ğŸ“‹ PASO 4: Conectar VNC Viewer"
            echo ""
            echo "   â€¢ Abrir VNC Viewer â†’ localhost:5900"
            echo "   â€¢ ContraseÃ±a: Runner123"
            echo "   â€¢ Usuario (si pide): macuser"
            echo ""
            echo "   âš ï¸ Es posible que los tÃºneles se cierren - ES NORMAL"
            echo ""
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo ""
            echo "ğŸ“‹ PASO 5: â­ RECONECTAR TÃšNELES (IMPORTANTE)"
            echo ""
            echo "   Si los tÃºneles se cerraron, volver a ejecutar:"
            echo ""
            echo "   PowerShell #1 (SSH):"
            echo "   cloudflared access tcp --hostname $SSH_TUNNEL_HOST --url localhost:2222"
            echo ""
            echo "   PowerShell #2 (VNC):"
            echo "   cloudflared access tcp --hostname $VNC_TUNNEL_HOST --url localhost:5900"
            echo ""
            echo "   â­ DESPUÃ‰S de reconectar, Pair to Mac funcionarÃ¡"
            echo ""
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo ""
          fi
          echo "ğŸ“‹ PASO 6: Configurar Visual Studio Pair to Mac"
          echo ""
          echo "   Tools > Options > Xamarin > iOS Settings > Pair to Mac"
          echo ""
          echo "   â€¢ Host:     localhost"
          echo "   â€¢ Port:     2222"
          echo "   â€¢ Username: macuser"
          echo "   â€¢ Password: Runner123"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "âœ… PASO 7: Â¡Listo!"
          echo "   Una vez emparejado, podrÃ¡s:"
          echo "   â€¢ Compilar proyectos iOS desde Visual Studio"
          echo "   â€¢ Usar el simulador de iOS remoto"
          echo "   â€¢ Depurar apps en dispositivos iOS conectados al Mac"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "      âš ï¸ SI APARECE ERROR 'no user session':"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   La clave es: RECONECTAR los tÃºneles despuÃ©s de VNC"
          echo ""
          echo "   1. Conecta SSH â†’ ejecuta /tmp/login_macuser.sh"
          echo "   2. Conecta VNC Viewer (los tÃºneles pueden cerrarse)"
          echo "   3. â­ RECONECTA los tÃºneles SSH y VNC"
          echo "   4. Intenta Pair to Mac de nuevo"
          echo ""
          echo "   ğŸ’¡ El secreto estÃ¡ en reconectar despuÃ©s de que VNC"
          echo "      haya creado la sesiÃ³n grÃ¡fica"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "              CONEXIÃ“N VNC (ESCRITORIO REMOTO)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ–¥ï¸  PASO 1: Crear tÃºnel VNC (en otra ventana de PowerShell):"
            echo ""
            echo "   cloudflared access tcp --hostname $VNC_TUNNEL_HOST --url localhost:5900"
            echo ""
            echo "ğŸ–¥ï¸  PASO 2: Conectar con cliente VNC a: localhost:5900"
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "              ALTERNATIVA: CONEXIÃ“N SSH DIRECTA"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   Si prefieres SSH directo desde PowerShell:"
          echo ""
          echo "   ssh -o ProxyCommand=\"cloudflared access tcp --hostname $SSH_TUNNEL_HOST\" runner@$SSH_TUNNEL_HOST"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Directorio del proyecto: $(pwd)"
          echo "ğŸ”§ Xcode version: $(xcodebuild -version | head -1)"
          echo "ğŸ”· .NET version: $(dotnet --version)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          MAC_PASSWORD: ${{ secrets.MAC_PASSWORD }}

      # ============================================
      # 11. Mantener sesiÃ³n activa
      # ============================================
      - name: â³ SesiÃ³n activa - Cancela el workflow para terminar
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   ğŸŸ¢ SESIÃ“N ACTIVA - Para terminar, cancela el workflow en GitHub"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Para cancelar: Ve a Actions > Este workflow > Cancel workflow"
          echo ""
          echo "âš ï¸  LÃ­mite mÃ¡ximo de GitHub Actions: 6 horas"
          echo ""
          
          # Mantener activo indefinidamente (hasta el timeout de GitHub o cancelaciÃ³n manual)
          while true; do
            echo "â±ï¸  $(date '+%Y-%m-%d %H:%M:%S') - SesiÃ³n activa..."
            
            # Verificar que los tÃºneles siguen activos
            if ! pgrep -f "cloudflared" > /dev/null; then
              echo "âš ï¸  TÃºnel desconectado, reiniciando..."
              nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
              sleep 5
            fi
            
            sleep 300  # Mostrar estado cada 5 minutos
          done

      # ============================================
      # 12. Limpieza
      # ============================================
      - name: ğŸ§¹ Limpieza
        if: always()
        run: |
          echo "Limpiando recursos..."
          pkill -f cloudflared || true
          sudo systemsetup -setremotelogin off || true
          echo "âœ… Limpieza completada"
