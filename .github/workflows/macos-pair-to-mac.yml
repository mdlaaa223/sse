# ================================================================================
# GitHub Workflow: Pair to Mac - Conectar Visual Studio Windows con Mac remoto
# ================================================================================
# Este workflow crea un tÃºnel seguro para emparejar Visual Studio 2022/2026 
# con un Mac remoto de GitHub Actions para compilar apps iOS.
#
# Â¡Â¡ GRATIS - NO REQUIERE TARJETA DE CRÃ‰DITO !!
# Usa Cloudflare Tunnel (cloudflared) que es completamente gratuito.
#
# INSTRUCCIONES:
# 1. Configura los secrets en GitHub (Settings > Secrets > Actions):
#    - MAC_PASSWORD: ContraseÃ±a para el usuario del Mac
#
# 2. Ejecuta este workflow manualmente desde Actions
#
# 3. Espera a que aparezca la URL del tÃºnel en los logs
#
# 4. En tu Windows local, instala cloudflared:
#    winget install Cloudflare.cloudflared
#    o descarga de: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
#
# 5. Configura el tÃºnel en tu mÃ¡quina local (PowerShell):
#    cloudflared access tcp --hostname <URL_DEL_TUNEL> --url localhost:22
#
# 6. En Visual Studio: Tools > Options > Xamarin > iOS Settings
#    - Mac Host: localhost
#    - Port: 22
#    - Username: runner
#    - Password: (el que configuraste en MAC_PASSWORD)
#
# NOTA: El workflow dura mÃ¡ximo 6 horas (lÃ­mite de GitHub Actions)
# ================================================================================

name: ğŸ Pair to Mac (Visual Studio)

on:
  workflow_dispatch:
    inputs:
      tunnel_type:
        description: 'Tipo de tÃºnel'
        required: true
        default: 'ssh_and_vnc'
        type: choice
        options:
          - ssh
          - ssh_and_vnc
      create_gui_session:
        description: 'Crear sesiÃ³n GUI con tmate (mÃ¡s confiable)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true

jobs:
  pair-to-mac:
    name: ğŸ–¥ï¸ Mac disponible para emparejar
    runs-on: macos-26
    timeout-minutes: 360  # MÃ¡ximo 6 horas
    
    steps:
      # ============================================
      # 1. Checkout del cÃ³digo (opcional, para tener el proyecto)
      # ============================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ============================================
      # 2. Mostrar informaciÃ³n del sistema
      # ============================================
      - name: ğŸ“‹ InformaciÃ³n del Sistema
        run: |
          echo "============================================"
          echo "   INFORMACIÃ“N DEL MAC REMOTO"
          echo "============================================"
          echo ""
          echo "ğŸ–¥ï¸  macOS Version:"
          sw_vers
          echo ""
          echo "ğŸ’» Hardware:"
          system_profiler SPHardwareDataType | grep -E "Model|Processor|Memory|Cores"
          echo ""
          echo "ğŸ”§ Xcode Version:"
          xcodebuild -version
          echo ""
          echo "ğŸ“± iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios
          echo ""
          echo "ğŸ”· .NET SDK:"
          dotnet --version
          echo ""
          echo "ğŸ‘¤ Usuario actual:"
          whoami
          echo ""
          echo "ğŸ  Directorio home:"
          echo $HOME

      # ============================================
      # 3. Seleccionar Xcode 26.2 (tiene simuladores)
      # ============================================
      - name: ğŸ”§ Configurar Xcode 26.2
        run: |
          echo "Buscando versiones de Xcode disponibles..."
          ls -la /Applications/ | grep Xcode
          
          # Usar Xcode 26.2 porque tiene los simuladores
          if [ -d "/Applications/Xcode_26.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
            echo "âœ… Xcode 26.2 seleccionado"
          elif [ -d "/Applications/Xcode_26.2.0.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.0.app/Contents/Developer
            echo "âœ… Xcode 26.2.0 seleccionado"
          else
            echo "âš ï¸ Usando Xcode por defecto"
          fi
          
          echo ""
          echo "Xcode seleccionado:"
          xcodebuild -version
          echo ""
          echo "iOS SDKs disponibles:"
          xcodebuild -showsdks | grep -i ios
          echo ""
          echo "Simuladores disponibles:"
          xcrun simctl list devices available | head -20

      # ============================================
      # 4. Instalar .NET MAUI workloads (compatible con Xcode 26.2)
      # ============================================
      - name: ğŸ“¦ Instalar .NET MAUI Workloads
        run: |
          echo "Instalando workloads de MAUI con soporte para Xcode 26.2..."
          
          # Instalar workloads de MAUI
          dotnet workload install maui
          
          # Actualizar especÃ­ficamente los workloads de iOS/Mac para Xcode 26.2
          echo ""
          echo "Actualizando workloads de iOS para compatibilidad con Xcode 26.2..."
          dotnet workload update --from-previous-sdk || true
          
          # Verificar versiones instaladas
          echo ""
          echo "âœ… Workloads instalados:"
          dotnet workload list
          
          echo ""
          echo "Verificando versiÃ³n del SDK de iOS:"
          dotnet --info | grep -i "ios" || true

      # ============================================
      # 5. Configurar SSH para conexiÃ³n remota
      # ============================================
      - name: ğŸ” Configurar SSH y Acceso Remoto
        id: ssh_config
        run: |
          echo "Configurando SSH..."
          
          # ContraseÃ±a fija para facilitar la conexiÃ³n
          PASSWORD="Runner123"
          
          # Crear un nuevo usuario para SSH (mÃ¡s confiable que modificar runner)
          if ! id "macuser" &>/dev/null; then
            echo "Creando usuario 'macuser' para SSH..."
            sudo sysadminctl -addUser macuser -password "$PASSWORD" -admin
          else
            echo "Usuario macuser ya existe"
          fi
          
          # Dar permisos de administrador al usuario
          sudo dseditgroup -o edit -a macuser -t user admin
          sudo dseditgroup -o edit -a macuser -t user wheel
          
          # Habilitar login remoto (SSH)
          sudo systemsetup -setremotelogin on
          
          # Configurar SSH para permitir autenticaciÃ³n por contraseÃ±a
          sudo sed -i '' 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^KbdInteractiveAuthentication no/KbdInteractiveAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^#UsePAM.*/UsePAM yes/' /etc/ssh/sshd_config
          sudo sed -i '' 's/^UsePAM no/UsePAM yes/' /etc/ssh/sshd_config
          
          # Agregar configuraciones explÃ­citas
          cat << 'EOF' | sudo tee -a /etc/ssh/sshd_config
          
          # ConfiguraciÃ³n para Pair to Mac
          PasswordAuthentication yes
          KbdInteractiveAuthentication yes
          UsePAM yes
          PermitRootLogin no
          EOF
          
          # Reiniciar servicio SSH
          sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist
          
          # Verificar que SSH estÃ¡ funcionando
          sleep 2
          if sudo lsof -i :22 | grep -q LISTEN; then
            echo "âœ… SSH estÃ¡ escuchando en puerto 22"
          else
            echo "âš ï¸ Intentando iniciar SSH de otra manera..."
            sudo launchctl start com.openssh.sshd || true
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  CREDENCIALES DE ACCESO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ‘¤ Usuario:     macuser"
          echo "  ğŸ”‘ ContraseÃ±a:  $PASSWORD"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Guardar para usar despuÃ©s
          echo "MAC_USER=macuser" >> $GITHUB_ENV
          echo "MAC_PASS=$PASSWORD" >> $GITHUB_ENV

      # ============================================
      # 5.1 Crear sesiÃ³n de usuario (requerido para Pair to Mac)
      # ============================================
      - name: ğŸ‘¤ Crear SesiÃ³n de Usuario para Pair to Mac
        run: |
          echo "Creando sesiÃ³n de usuario para Visual Studio Pair to Mac..."
          
          PASSWORD="Runner123"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 1: Configurar contraseÃ±a para 'runner' usando sysadminctl
          # El usuario 'runner' YA tiene sesiÃ³n GUI activa en GitHub Actions
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Intentando configurar contraseÃ±a para 'runner'..."
          
          # MÃ©todo A: Usar sysadminctl para crear/resetear contraseÃ±a
          # En macOS, podemos usar -adminUser con el usuario actual si tiene permisos
          sudo sysadminctl -resetPasswordFor runner -newPassword "$PASSWORD" -passwordHint "pair" 2>/dev/null || {
            echo "MÃ©todo A fallÃ³, intentando mÃ©todo B..."
            
            # MÃ©todo B: Usar dscl con SecureToken
            sudo dscl . -passwd /Users/runner "" "$PASSWORD" 2>/dev/null || {
              echo "MÃ©todo B fallÃ³, intentando mÃ©todo C..."
              
              # MÃ©todo C: Crear entrada de contraseÃ±a directamente
              sudo security set-keychain-password -o "" -p "$PASSWORD" /Users/runner/Library/Keychains/login.keychain-db 2>/dev/null || true
            }
          }
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 2: Crear sesiÃ³n GUI real para 'macuser'
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Configurando sesiÃ³n GUI para 'macuser'..."
          
          MACUSER_UID=$(id -u macuser)
          RUNNER_UID=$(id -u runner)
          echo "UID de macuser: $MACUSER_UID"
          echo "UID de runner: $RUNNER_UID"
          
          # Crear el directorio home completo para macuser
          sudo mkdir -p /Users/macuser/Library/Preferences
          sudo mkdir -p /Users/macuser/Library/LaunchAgents
          sudo mkdir -p /Users/macuser/Library/Caches
          sudo chown -R macuser:staff /Users/macuser
          
          # Copiar configuraciones bÃ¡sicas desde runner
          sudo cp -R /Users/runner/Library/Preferences/* /Users/macuser/Library/Preferences/ 2>/dev/null || true
          sudo chown -R macuser:staff /Users/macuser/Library/Preferences
          
          # Habilitar auto-login para macuser (esto ayuda a crear la sesiÃ³n)
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser macuser
          sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUserUID $MACUSER_UID
          
          # Crear el bootstrap GUI para macuser
          sudo launchctl bootstrap gui/$MACUSER_UID /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
          sudo launchctl asuser $MACUSER_UID launchctl load -S Aqua /System/Library/LaunchAgents/com.apple.Finder.plist 2>/dev/null || true
          
          # Iniciar una sesiÃ³n de login para macuser
          # Esto simula un login grÃ¡fico
          sudo /System/Library/CoreServices/loginwindow.app/Contents/MacOS/loginwindow console $MACUSER_UID 2>/dev/null &
          sleep 3
          
          # Configurar Remote Management para ambos usuarios
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -users macuser,runner \
            -privs -all \
            -restart -agent 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 3: Iniciar el Broker de XMA (Xamarin Mac Agent)
          # Este es el servicio que Visual Studio busca
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          echo "Preparando Xamarin Mac Agent para ambos usuarios..."
          
          # El XMA Broker necesita correr como el usuario conectado
          # Creamos un script que lo inicia para macuser
          
          cat << 'SCRIPT' | sudo tee /tmp/start_xma_session.sh
          #!/bin/bash
          # Iniciar sesiÃ³n de usuario para XMA
          export HOME=/Users/macuser
          export USER=macuser
          export LOGNAME=macuser
          
          # Crear el archivo de sesiÃ³n que XMA busca
          mkdir -p /Users/macuser/Library/Application\ Support/Xamarin
          touch /Users/macuser/Library/Application\ Support/Xamarin/.session
          
          # Mantener la sesiÃ³n activa
          while true; do
            sleep 60
          done
          SCRIPT
          
          sudo chmod +x /tmp/start_xma_session.sh
          sudo -u macuser /tmp/start_xma_session.sh &
          
          # TambiÃ©n para runner
          mkdir -p "/Users/runner/Library/Application Support/Xamarin" 2>/dev/null || true
          touch "/Users/runner/Library/Application Support/Xamarin/.session" 2>/dev/null || true
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # MÃ‰TODO 4: Forzar creaciÃ³n de sesiÃ³n GUI usando launchd
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # Crear un LaunchAgent que mantiene viva la sesiÃ³n
          cat << 'PLIST' | sudo tee /Library/LaunchDaemons/com.github.usersession.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>com.github.usersession</string>
              <key>ProgramArguments</key>
              <array>
                  <string>/bin/bash</string>
                  <string>-c</string>
                  <string>launchctl asuser 502 /bin/bash -c "export HOME=/Users/macuser; while true; do sleep 60; done"</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              <key>UserName</key>
              <string>root</string>
          </dict>
          </plist>
          PLIST
          
          sudo launchctl load /Library/LaunchDaemons/com.github.usersession.plist 2>/dev/null || true
          
          # Verificar sesiones
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Sesiones activas despuÃ©s de configuraciÃ³n:"
          who -a 2>/dev/null || true
          echo ""
          echo "Procesos de loginwindow:"
          ps aux | grep -i loginwindow | grep -v grep || true
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo ""
          echo "âœ… ConfiguraciÃ³n de sesiÃ³n completada"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  IMPORTANTE: Si 'macuser' sigue sin funcionar, usa 'runner'    â•‘"
          echo "â•‘  pero deberÃ¡s probar si la contraseÃ±a se configurÃ³ bien.       â•‘"
          echo "â•‘                                                                 â•‘"
          echo "â•‘  Usuario: macuser  |  ContraseÃ±a: Runner123                    â•‘"
          echo "â•‘  Usuario: runner   |  ContraseÃ±a: Runner123 (si funcionÃ³)      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 6. Configurar VNC (si se selecciona)
      # ============================================
      - name: ğŸ–¥ï¸ Configurar VNC/Screen Sharing
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Configurando VNC/Screen Sharing..."
          
          PASSWORD="Runner123"
          
          # Primero detener cualquier proceso ARD existente
          sudo killall ARDAgent 2>/dev/null || true
          sleep 2
          
          # Habilitar Screen Sharing (VNC) con configuraciÃ³n completa
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$PASSWORD" \
            -restart -agent -privs -all
          
          # Configurar Screen Sharing directamente
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false 2>/dev/null || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Verificar que VNC estÃ¡ escuchando
          sleep 3
          if sudo lsof -i :5900 | grep -q LISTEN; then
            echo "âœ… VNC estÃ¡ escuchando en puerto 5900"
          else
            echo "âš ï¸ VNC puede no estar activo, intentando iniciar..."
            sudo launchctl start com.apple.screensharing || true
          fi
          
          echo "âœ… VNC/Screen Sharing habilitado"
          echo "ğŸ–¥ï¸ Puerto VNC: 5900"
          echo "ğŸ”‘ ContraseÃ±a VNC: $PASSWORD"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  IMPORTANTE: El VNC puede interferir con SSH                     â•‘"
          echo "â•‘  Si la sesiÃ³n SSH se cierra, espera unos segundos y reconecta    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 6.1 SesiÃ³n interactiva con tmate (mÃ¡s confiable)
      # ============================================
      - name: ğŸ”§ Configurar SesiÃ³n Interactiva con tmate
        if: ${{ github.event.inputs.create_gui_session == 'true' }}
        run: |
          echo "Instalando tmate para sesiÃ³n interactiva..."
          brew install tmate
          
          # Crear script para login de macuser (sin pedir contraseÃ±a)
          cat << 'LOGINSCRIPT' | sudo tee /tmp/login_macuser.sh
          #!/bin/bash
          # Script para iniciar sesiÃ³n como macuser SIN PEDIR CONTRASEÃ‘A
          echo "==================================="
          echo "Iniciando sesiÃ³n como macuser..."
          echo "==================================="
          
          # Usar sudo para cambiar a macuser sin contraseÃ±a
          sudo -u macuser bash -c '
            export HOME=/Users/macuser
            export USER=macuser
            cd ~
            
            # Crear marcador de sesiÃ³n para XMA (Xamarin Mac Agent)
            mkdir -p ~/Library/Application\ Support/Xamarin
            touch ~/Library/Application\ Support/Xamarin/.session
            
            echo "âœ… SesiÃ³n de macuser iniciada"
            echo "ğŸ“ Directorio: $(pwd)"
            echo "ğŸ‘¤ Usuario: $(whoami)"
            echo ""
            echo "Esta sesiÃ³n se mantendrÃ¡ activa."
            echo "NO CIERRES ESTA VENTANA mientras uses Pair to Mac."
            echo ""
            
            # Mantener sesiÃ³n activa indefinidamente
            while true; do
              sleep 30
              echo "â±ï¸ $(date) - SesiÃ³n activa..."
            done
          '
          LOGINSCRIPT
          sudo chmod +x /tmp/login_macuser.sh
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  SESIÃ“N TMATE DISPONIBLE                                         â•‘"
          echo "â•‘  Usa esta sesiÃ³n para hacer login manual como macuser            â•‘"
          echo "â•‘  y luego probar Pair to Mac desde Visual Studio                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================
      # 7. Instalar Cloudflare Tunnel
      # ============================================
      - name: â˜ï¸ Instalar Cloudflare Tunnel
        run: |
          echo "Instalando cloudflared..."
          brew install cloudflare/cloudflare/cloudflared
          cloudflared --version
          echo "âœ… Cloudflared instalado"

      # ============================================
      # 8. Iniciar tÃºnel SSH
      # ============================================
      - name: ğŸš‡ Iniciar TÃºnel SSH
        id: ssh_tunnel
        run: |
          echo "Iniciando tÃºnel SSH con Cloudflare..."
          
          # Iniciar tÃºnel en background
          nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
          SSH_TUNNEL_PID=$!
          echo "SSH_TUNNEL_PID=$SSH_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el tÃºnel estÃ© listo
          echo "Esperando a que el tÃºnel estÃ© listo..."
          sleep 15
          
          # Obtener URL del tÃºnel
          SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "")
          
          if [ -z "$SSH_TUNNEL_URL" ]; then
            echo "Reintentando obtener URL..."
            sleep 10
            SSH_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/ssh_tunnel.log || echo "URL_NO_DISPONIBLE")
          fi
          
          # Convertir a hostname sin https://
          SSH_TUNNEL_HOST=$(echo "$SSH_TUNNEL_URL" | sed 's|https://||')
          
          echo "SSH_TUNNEL_URL=$SSH_TUNNEL_URL" >> $GITHUB_ENV
          echo "SSH_TUNNEL_HOST=$SSH_TUNNEL_HOST" >> $GITHUB_ENV
          echo "ssh_url=$SSH_TUNNEL_HOST" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… TÃºnel SSH iniciado"
          echo "ğŸ”— URL: $SSH_TUNNEL_URL"

      # ============================================
      # 9. Iniciar tÃºnel VNC (si se selecciona)
      # ============================================
      - name: ğŸš‡ Iniciar TÃºnel VNC
        id: vnc_tunnel
        if: ${{ github.event.inputs.tunnel_type == 'ssh_and_vnc' }}
        run: |
          echo "Iniciando tÃºnel VNC con Cloudflare..."
          
          # Iniciar tÃºnel en background
          nohup cloudflared tunnel --url tcp://localhost:5900 --logfile /tmp/vnc_tunnel.log 2>&1 &
          VNC_TUNNEL_PID=$!
          echo "VNC_TUNNEL_PID=$VNC_TUNNEL_PID" >> $GITHUB_ENV
          
          # Esperar a que el tÃºnel estÃ© listo
          sleep 15
          
          # Obtener URL del tÃºnel
          VNC_TUNNEL_URL=$(grep -m 1 -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' /tmp/vnc_tunnel.log || echo "URL_NO_DISPONIBLE")
          VNC_TUNNEL_HOST=$(echo "$VNC_TUNNEL_URL" | sed 's|https://||')
          
          echo "VNC_TUNNEL_URL=$VNC_TUNNEL_URL" >> $GITHUB_ENV
          echo "VNC_TUNNEL_HOST=$VNC_TUNNEL_HOST" >> $GITHUB_ENV
          
          echo ""
          echo "âœ… TÃºnel VNC iniciado"
          echo "ğŸ”— URL: $VNC_TUNNEL_URL"

      # ============================================
      # 10. Mostrar instrucciones de conexiÃ³n
      # ============================================
      - name: ğŸ“‹ Instrucciones de ConexiÃ³n
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                    â•‘"
          echo "â•‘   ğŸ MAC REMOTO LISTO PARA EMPAREJAR CON VISUAL STUDIO ğŸ        â•‘"
          echo "â•‘                                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    INFORMACIÃ“N DE CONEXIÃ“N"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”— TÃºnel SSH:     $SSH_TUNNEL_URL"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  USUARIOS DISPONIBLES (prueba en este orden):                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ‘¤ OpciÃ³n 1 (RECOMENDADO - tiene sesiÃ³n activa):              â•‘"
          echo "â•‘     Usuario:    runner                                          â•‘"
          echo "â•‘     ContraseÃ±a: Runner123                                       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ‘¤ OpciÃ³n 2 (alternativa):                                     â•‘"
          echo "â•‘     Usuario:    macuser                                         â•‘"
          echo "â•‘     ContraseÃ±a: Runner123                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â±ï¸  DuraciÃ³n:      Hasta que canceles el workflow manualmente"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "ğŸ–¥ï¸  TÃºnel VNC:     $VNC_TUNNEL_URL"
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           PASOS PARA CONECTAR DESDE WINDOWS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¥ PASO 1: Instalar cloudflared en tu Windows"
          echo "   Abre PowerShell como Administrador y ejecuta:"
          echo ""
          echo "   winget install Cloudflare.cloudflared"
          echo ""
          echo "   O descarga manualmente de:"
          echo "   https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "ğŸ”Œ PASO 2: Crear tÃºnel local (PowerShell)"
          echo "   Ejecuta este comando para crear el tÃºnel:"
          echo ""
          echo "   cloudflared access tcp --hostname $SSH_TUNNEL_HOST --url localhost:2222"
          echo ""
          echo "   âš ï¸  MantÃ©n esta ventana abierta mientras uses el Mac"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "ğŸ”§ PASO 3: Configurar Visual Studio"
          echo ""
          echo "   A) Ve a: Tools > Options > Xamarin > iOS Settings"
          echo ""
          echo "   B) En 'Pair to Mac', configura:"
          echo "      â€¢ Host:     localhost"
          echo "      â€¢ Port:     2222"
          echo ""
          echo "   C) Haz clic en 'Pair' e ingresa:"
          echo "      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "      â”‚  ğŸ‘‰ PRUEBA PRIMERO CON:                     â”‚"
          echo "      â”‚     Username: runner                        â”‚"
          echo "      â”‚     Password: Runner123                     â”‚"
          echo "      â”‚                                             â”‚"
          echo "      â”‚  Si no funciona, intenta con:               â”‚"
          echo "      â”‚     Username: macuser                       â”‚"
          echo "      â”‚     Password: Runner123                     â”‚"
          echo "      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "âœ… PASO 4: Â¡Listo!"
          echo "   Una vez emparejado, podrÃ¡s:"
          echo "   â€¢ Compilar proyectos iOS desde Visual Studio"
          echo "   â€¢ Usar el simulador de iOS remoto"
          echo "   â€¢ Depurar apps en dispositivos iOS conectados al Mac"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "      âš ï¸ SI APARECE ERROR 'no user session' SIGUE ESTOS PASOS:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   ğŸ“‹ ORDEN CORRECTO DE CONEXIÃ“N:"
          echo ""
          echo "   1. PRIMERO: Abre una ventana de PowerShell para el tÃºnel SSH:"
          echo "      cloudflared access tcp --hostname $SSH_TUNNEL_HOST --url localhost:2222"
          echo ""
          echo "   2. SEGUNDO: Abre OTRA ventana de PowerShell y conÃ©ctate:"
          echo "      ssh -p 2222 macuser@localhost"
          echo "      (ContraseÃ±a: Runner123)"
          echo ""
          echo "   3. TERCERO: Dentro del Mac, ejecuta:"
          echo "      /tmp/login_macuser.sh"
          echo "      (Ya NO pide contraseÃ±a)"
          echo ""
          echo "   4. MANTÃ‰N ESA SESIÃ“N SSH ABIERTA (no la cierres)"
          echo ""
          echo "   5. CUARTO: En Visual Studio, intenta Pair to Mac"
          echo "      - Si falla, haz clic en 'Retry'"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "   âš ï¸ NOTA SOBRE VNC:"
            echo "   - Si usas VNC Viewer, conÃ©ctate DESPUÃ‰S de que SSH funcione"
            echo "   - VNC puede cerrar temporalmente la sesiÃ³n SSH"
            echo "   - Si SSH se cierra, espera 5 segundos y reconecta"
            echo ""
          fi
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          if [ "${{ github.event.inputs.tunnel_type }}" == "ssh_and_vnc" ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "              CONEXIÃ“N VNC (ESCRITORIO REMOTO)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ–¥ï¸  PASO 1: Crear tÃºnel VNC (en otra ventana de PowerShell):"
            echo ""
            echo "   cloudflared access tcp --hostname $VNC_TUNNEL_HOST --url localhost:5900"
            echo ""
            echo "ğŸ–¥ï¸  PASO 2: Conectar con cliente VNC a: localhost:5900"
            echo ""
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "              ALTERNATIVA: CONEXIÃ“N SSH DIRECTA"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "   Si prefieres SSH directo desde PowerShell:"
          echo ""
          echo "   ssh -o ProxyCommand=\"cloudflared access tcp --hostname $SSH_TUNNEL_HOST\" runner@$SSH_TUNNEL_HOST"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Directorio del proyecto: $(pwd)"
          echo "ğŸ”§ Xcode version: $(xcodebuild -version | head -1)"
          echo "ğŸ”· .NET version: $(dotnet --version)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          MAC_PASSWORD: ${{ secrets.MAC_PASSWORD }}

      # ============================================
      # 11. Mantener sesiÃ³n activa
      # ============================================
      - name: â³ SesiÃ³n activa - Cancela el workflow para terminar
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   ğŸŸ¢ SESIÃ“N ACTIVA - Para terminar, cancela el workflow en GitHub"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Para cancelar: Ve a Actions > Este workflow > Cancel workflow"
          echo ""
          echo "âš ï¸  LÃ­mite mÃ¡ximo de GitHub Actions: 6 horas"
          echo ""
          
          # Mantener activo indefinidamente (hasta el timeout de GitHub o cancelaciÃ³n manual)
          while true; do
            echo "â±ï¸  $(date '+%Y-%m-%d %H:%M:%S') - SesiÃ³n activa..."
            
            # Verificar que los tÃºneles siguen activos
            if ! pgrep -f "cloudflared" > /dev/null; then
              echo "âš ï¸  TÃºnel desconectado, reiniciando..."
              nohup cloudflared tunnel --url tcp://localhost:22 --logfile /tmp/ssh_tunnel.log 2>&1 &
              sleep 5
            fi
            
            sleep 300  # Mostrar estado cada 5 minutos
          done

      # ============================================
      # 12. Limpieza
      # ============================================
      - name: ğŸ§¹ Limpieza
        if: always()
        run: |
          echo "Limpiando recursos..."
          pkill -f cloudflared || true
          sudo systemsetup -setremotelogin off || true
          echo "âœ… Limpieza completada"
